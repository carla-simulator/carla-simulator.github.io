---
layout: post
comments: true
title:  "CARLA 0.9.8 release"
subtitle: "Night mode, extended API, new weather, improvements on the traffic manager, Autoware and SUMO integrations and new documentation."
description: ""
author: "@sergi-e"
date:   2020-02-05 8:00:00 +0002
image: 'img/carla.jpg'
background: '/img/posts/2019-12-11/Bann001.jpg'
---

The CARLA team is delighted to finally announce the release of  **CARLA 0.9.8**!

This release entails a whole new experience for the CARLA simulator, as many different areas have been improved. The Python API has been extended to manage splines and spirals, now giving support to all the geometries defined in OpenDRIVE. Also, new functionalities have been added to the Waypoint class and a new one, Junction, has been created to manage road intersections. The improvements in this release propagate to the Traffic manager, that now provides support to multiclient and multi Traffic manager scenarios, with a significant decrease in computation costs. The ROS bridge has also been iterated on so that CARLA provides full integration with AutoWare!  
Regarding the aesthetics, a whole new night mode has been developed including street lightning and car lights. The weather parametrization has been upgraded to include now fog, wetness and wind effects for clouds, vegetation and rain direction. Also, Mesh distance fields have definitely come back and a very special asset is now drifting around the CARLA streets.  
Last but not least, new documentation is available and much more will be provided soon. Of course, don't forget to mention that the [CARLA forum](https://forum.carla.org/) is out there now for the community! 

Let's take a look! 

{% include youtube.html id="9aFK-enG5dQ" %}

{% include release_button.html release_tag="0.9.7" %}

## New weather 
---

This upgrade includes two features that are completely new.  
Firstly, there is the __fog__, that can be managed using two parameters: density and distance. 
<u>Distance</u> sets the meters for the fog to start being applied. From that starting point, the <u>density</u> will regulate the opacity of that will slowly fade the further elements in scene. 
Ya no de blanco a negro, profundidad. 

![weather_fog](/img/posts/2020-03-03/fog01.gif){:class="img-fluid"}

There is also a new __wetness__ parameter that states the humidity of the road. In comparison to the precipitation deposits previously existing, this slowly applies a fader to the road instead of creating different pods along it. 

![weather_wetness](/img/posts/2020-03-03/wetness01.gif){:class="img-fluid"}

Regarding the __wind__, in previous releases the wind speed only was evident when tree leaves moved. Not it also affects the rain direction, the clouds movement and other types of vegetation. 

![weather_wind](/img/posts/2020-03-03/wind01.gif){:class="img-fluid"}

Other visual improvements have been made: rain particles have been changed for a more realistic effect. The sun intensity, regulated by the sun position and cloudiness, affects the intensity and color temperature of the light. Also, quite similar to this, the more cloudy the day is, the darker the sky will be. 

All of these can be perceived using a RGB camera sensor. The __dynamic_weather.py__ script in `/PythonAPI/examples` has been updated to include all of these changes in its cycles, but the CARLA team also provides with another script, 
CARLA team also provides a script, __Weather.py__ in  `/Utils/` that allows to set the weather parameters at will: 

```sh
#Set a midday scenario
/carla/PythonAPI/util >weather.py  --altitude 90 --azimuth 220
#Change to a midnight scenario
/carla/PythonAPI/util >weather.py  --altitude -90 --azimuth 220
```

![weather_code](/img/posts/2020-03-03/weather.gif){:class="img-fluid"}

## Night mode
---

A whole new world in CARLA! The moment the sun disappears in the horizon (being so that the angle goes under 0), it is considered night time. 
When night comes, the city lights are automatically turned on. There are different types of street lights available, which correspond to the models that where previously in the different towns. 

![Streetlights](/img/posts/2020-03-03/Streetlights02.png){:class="img-fluid"}

__Warning:__ _Be careful when playing around in night mode, as the complex lightning may cause FPS drops. As an estimation, by the time of the release every city is able to manage a hundred vehicles with no drops under the 20FPS._ 

### Vehicle lights

Right now, only the vehicles managed by the user will be able to turn on their lights. These have been implemented for a specific set of vehicles so far: 
* __Bikes:__ all of them have a front and back position light. 
* __Motorcycles:__ Yamaha and Harley Davidson models 
* __Cars:__ Audi TT, Chevrolet, Dodge (the police car), Etron, Lincoln, Mustang, Tesla 3S, Wolkswagen T2 and the new guest coming to CARLA. 

Speaking of which... The Cybertruck is here! 

![Cybertruck](/img/posts/2020-03-03/Cybertruck.png){:class="img-fluid"}

The lights included sum all of the common front and back lights in a car, and some special ones such as license plate, interior light or sirens. Some of them turn on automatically (brake and reverse lights), but most of them though are implemented to be accessed through the API. Each vehicle has the usual set of lights that could be found in real life. That means that cars count with the whole set, but bikes only have low front and back position lights. 

To turn vehicle lights on/off through the API, there is the helper class [carla.VehicleLightState](https://carla.readthedocs.io/en/latest/python_api/#carlavehiclelightstate) which contains the set of lights as flags. These can be enabled or disabled using binary operations. 

```py
#To turn on position lights  

current_lights = carla.VehicleLightState.NONE
...
current_lights |= carla.VehicleLightState.Position
vehicle.set_light_state(current_lights)
```
The __manual_control.py__ script provided in `/PythonAPI/examples` has been updated to include commands for lights. Left/Right blinkers correspond to the `Z/X` keys. High beams are turned on while pressing `Shift+L` and the rest of the lights follow a cycle with the `L` key that follows the structure: `off>position light+license plate>low beam>fog lights`.

![car_lights](/img/posts/2020-03-03/carlights.gif){:class="img-fluid"}

## Mesh distance fields
---

Thanks to the information gained with distance fields, the lightning and shadows in scenes can be dramatically improved using different features. In previous releases distance fields were disabled due to ghosting issues that now have been minimized. Some weird shadow behaviour might still happen, but the realism achieved using them is much greater than what the current issue is. Let's take a look. 

Using distance fields, the __Distance field shadows__ are enabled, creating diffuse shadow edges instead of hard ones. This work hand in hand with the previous method of Cascade shadows to get a much more desirable effect. Also, the __Distance field ambient occlusion__ along with the previous Screen space ambient occlusion help placing the objects on scene by creating shadows that take into consideration the proximity between elements. 

<iframe frameborder="0" class="juxtapose" width="100%" height="394" src="https://cdn.knightlab.com/libs/juxtapose/latest/embed/index.html?uid=e7b331a0-5ca4-11ea-b9b8-0edaf8f81e27"></iframe>

Mesh distance fields is quite a complex feature that allows for these and many other different ways to improve the realness of the simulation. To learn more about it and its possibilities take a look at [Unreal Engine's documentation](https://docs.unrealengine.com/en-US/Engine/Rendering/LightingAndShadows/DistanceFieldAmbientOcclusion/index.html). Some of these will be implemented in future releases. However, if the ghosting is still an issue, it is an option for the user to disable it at anytime. This can be done in two different ways, either using the Unreal Engine editor or through code. 

To disable mesh distance fields via code, in `DefaultEngine.ini` set to false the parameter `r.GenerateMeshDistanceFields=False`. To do it in the Unreal Engine Editor, go to __Project Settings__, look up _mesh distance fields_ and just disable these:  

![DisableMDF](/img/posts/2020-03-03/DisableMDF.png){:class="img-fluid"}


## API extension
---



## Traffic manager
---

The improvements regarding the traffic manager are mostly related to computational efficiency. 

==> Anticipation algorithm at junctions avoid going on if there is a queue. 

==> Connectivity in waypoints to avoid fake lane changes
--> Deleted fake junctions stated by OpenDRIVE, only for traffic manager. 
--> Repeated elements in traffic manager lists. 

Scenario runer is secret? 



## Documentation 
---

There have been great changes in the CARLA documentation!
Almost everything has been revisited, from the installation and build guides to the Python API and sensor references. Everything is now up to date with the current state of CARLA.  
There have been also remarkable changes on the structure of the documentation to ease the learning curve. The __First steps__ section now acts as a step by step guide for newcomers, and the __Advanced steps__ include deeper explanations for some specific CARLA features.  
There is also some new documentation regarding some features such as __Traffic manager__ and the __ROS bridge__.  

Check all of these changes in the new [documentation](https://carla.readthedocs.io/en/latest/python_api/)!

Besides that, CARLA has a forum now!
The forum is meant to be a place to gather doubts, ideas, contributions, suggestions... By using it, keeping track of previous issues and solutions will be much easier. Eventually, the forum should allow the CARLA users to have a place to meet the rest of the CARLA community and improve the project all together. 

<div class="build-buttons">
<p>
<a href="https://forum.carla.org/" target="_blank" class="btn btn-neutral" title="Go to the CARLA forum">
Go to the CARLA forum</a>
</p>
</div>


## Change Log
---

- Python API extensions:  
  + New class __Junction__.  
  + Class __Waypoint__ extended. 
  + Class __Vector3D__ extended. 
  + Method __get_waypoint()__ extended for new geometries.
  + OpenDRIVE spirals and splines support. 
  + 

- Traffic manager:  
  + Enhanced waypoint connectivity.  
  + Improved performance by avoiding internal lists repetitions.  
  + Traffic light groups have now customized time cycles to improve performance and avoid jams.  

- Implementation of mesh distance fields for dynamic shadows. 
 
- New weather: 
  + Fog feature with density and distance parameters. 
  + Wetness (percentage) feature: humidity of the road. 
  + Wind affects clouds, vegetation and rain direction. 
  + New features are accessible from the Python API. 
  + Weather script in `/Utils` eases weather control by the user. 
  + New rain particles. 

- Night mode: 
  + Night defined as the moment sun goes below 0 degrees (horizon). 
  + City lights automatically turn on when in night mode (listed below).  
  + Car lights have been added for a few examples (listed below).  

- City lights available in night mode: 
  + Highway light.
  + Multiple highway light. 
  + Simple street light.
  + Double street light. 
  + Wall street light. 
  + Tall lampost street light. 
  + Short lampost street light. 
  + Lampost wall. 
  + Railway light. 

- Car lights: 
  + Lights are only available for user controlled cars. 
  + Lights have to be turned on by the user. Otherwise these will be off even in night mode.
  + All the lights are accessible from the API.  
  + Manual control `L` key manages lights in four states: off, position, low beam and fog lights. 
  + Manual control `shitf+L` turns on main beam lights. 
  + Manual control `Z` and `C` control indicator lamps. 
  + A few lights are automatic for controlled vehicle: brake... 

- List of vehicle lights: 
  + Indicator (front and back).
  + Position (front and back). 
  + Antifog (front and back).
  + Low beam.
  + High beam.
  + Brake. 
  + Reverse. 
  + License plate. 
  + Special. 

- Cars with lights: 
  + Cybertruck. 
  + Etron. 
  + Lincoln.
  + Mustang.
  + Tesla 3S.
  + Wolkswagen T2. 
  + Chevrolet. 
  + Police car (Dodge). 
  + Audi TT. 

- Motorycles with lights: 
  + Yamaha. 
  + Harley Davidson.

- Bikes with lights: 
  + All of them. 

- Assets
  + New vehicle: Cybertruck. 

- Visual quality
  + Sun intensity determines color temperature of the light. 
  + Sun intensity affected by sun position and cloudiness. 
  + Darkness of the clouds affected by amount of these. 
  + New sets of colors for vehicles to look more realistic. 
  + Different LODs for vehicles with no effect on lights. 

- Scenario runner improvements. 
  + Feedback retrieved by the leaderboard. 
  + Collision metric avoids hugh drops when stuck: remembers where the collision occurs and if it happens within two meters, score substraction is refrained. 
  + Stepping out of the lane metric is no longer binary. Takes into account an edge case for sidewalks, shoulders and opposite lanes. 
  + Note: the lane metric stops counting when in junctions due to complexity. 

- CARLA forum open to everybody. 

- New documentation
  + CARLA Forum
  + Python API
  + CARLA introduction
  + Quick start
  + Linux build
  + Windows build
  + Updating CARLA
  + F.A.Q.
  + Traffic manager??
  + Time step VS synchrony?? 

- Fixes
  + Docker: binary build issue fixed. 
  + Python API documentation: Index now properly ordered. 
  + Town 03: inconsistencies between OpenDRIVE and some traffic signs.
  + Traffic manager: Fake lane changes (especially  present in Town03) have been fixed.
  + Traffic manager: Fake junctions (present in barns and double lanes with lane departures) have been fixed.
  + Traffic manager: Stuck vehicles now are deleted after 90 seconds both in asynchronous and synchronous modes (---> wait, simulated or real seconds?).  
  + Windows: make Python API fixed. 

- Warning
  + Night mode with more than X actors on scene causes FPS drops that may interfere with the Traffic manager.


---

---

---

## API extension
---

Description

{% include youtube.html id="qBkLxA9gj6c" %}

List of items

* describing
* variables


## Feature 02
---


### **SUBFEATURE**

Description
`coolname` and always link the [API](https://carla.readthedocs.io/en/latest/python_api/).


**Code example**

```py
...

```

**Visualization example**

Description and relationship between the code and the video. 

{% include youtube.html id="Qrug8mMW070" %}
>Radar speed information with the RGB camera


Check it out in our [tutorial](https://carla.readthedocs.io/en/latest/how_to_generate_pedestrians_navigation)!

>Image caption. 



## New illumination system
---

With the new SSAO function, we achieved more natural shadows, boosting the Ambient Occlusion effect in real time.

<iframe frameborder="0" class="juxtapose" width="100%" height="394" src="https://cdn.knightlab.com/libs/juxtapose/latest/embed/index.html?uid=09521b78-1c54-11ea-b9b8-0edaf8f81e27"></iframe>


We added HDRi images to illuminate indirect lighting in the scene to achive a more realistic look.