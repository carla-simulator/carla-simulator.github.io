---
layout: post
comments: true
title:  "CARLA 0.9.8 release"
subtitle: "CARLA and ROS Debian packages, night mode, weather extension, improvements on the traffic manager, new documentation, SUMO co-simulation and much more."
description: "CARLA and ROS Debian packages, night mode, weather extension, improvements on the traffic manager, new documentation, SUMO integration and much more."
author: "@sergi-e"
date:   2020-02-05 8:00:00 +0002
image: 'img/carla.jpg'
background: '/img/posts/2019-12-11/Bann001.jpg'
---

The CARLA team is delighted to finally announce the release of  **CARLA 0.9.8**!

This release entails a whole new experience for the CARLA simulator, as many different areas have been improved. However, there are two honorable mentions to be done: the new Debian repositories that allow to directly download this latest release or the ROS bridge and the [CARLA forum](https://forum.carla.org/), a place for the community to gather around!  
Here is a brief summary of what CARLA 0.9.8 brings to the table:  

* __[CARLA 0.9.8 apt installation:](#carla-098-apt-installation)__ how to get this release in Linux using the Debian package.
* __[Weather extension:](#weather-extension)__ new parameters for fog and wetness of the road, besides many visual improvements.  
* __[Night mode](#night-mode):__ the sun sets in CARLA and the streets and vehicles turn on their lights. A complete makeover for the simulations.  
* __[Mesh distance fields](#mesh-distance-fields):__ these are actually back, after solving ghosting issues.
* __[ROS bridge](#ros-bridge):__ now with a package installation and more launchfiles provided to run ego vehicles and route scenarios. Soon, CARLA connection with Autoware will be straightforward!
* __[Python API extension](#python-api-extension):__ including all the OpenDRIVE geometries and new features for an upcoming major extension. 
* __[Traffic Manager](#traffic-manager):__ now with multiclient and multiTM support, besides reducing computational costs. 
* __[Documentation](#documentation):__ from the installation process to first steps for newcomers and in-depth explanation of advanced features. 
* __[Beta features](#beta-features):__ an introduction to SUMO co-simulation and the OpenDRIVE standalone mode. 
* __[Changelog](#changelog):__ check all of these changes and other fixes and additions.  

Let's take a look! 

{% include youtube.html id="9aFK-enG5dQ" %}

{% include release_button.html release_tag="0.9.8" %}

## CARLA 0.9.8 apt installation
---

Thanks to the Debian package, getting this release in Linux is more straightforward than ever: 

!! Update repository

```sh
#Install dependencies
pip install --user pygame numpy
#Add the repository
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys DB53A429E64554FC &&
sudo add-apt-repository "deb [trusted=yes] http://dist.carla.org/carla-0.9.7/ bionic main"
#Install CARLA
sudo apt-get update
sudo apt-get install carla
#CARLA is in the /opt/ folder
cd /opt/carla
#Get the resources for the simulator. 
./ImportAssets.sh
#Run the CARLA server. 
cd bin
./CarlaUE4.sh
```

## Weather extension
---

This upgrade includes two features that are completely new.  
Firstly, there is the __fog__, that can be managed using two parameters: density and distance. 
<u>Distance</u> sets the meters for the fog to start being applied. From that starting point, the <u>density</u> will regulate the opacity of that will slowly fade the further elements in scene. 
```sh
/carla/PythonAPI/util >weather.py --clouds 100 --rain 80 --wetness 100 --puddles 60 --wind 80 --fog 50
```
![weather_fog](/img/posts/2020-03-03/fog01.gif){:class="img-fluid"}

There is also a new __wetness__ parameter that states the humidity of the road. In comparison to the precipitation deposits previously existing, this slowly applies a fader to the road instead of creating different pods along it. 
```sh
/carla/PythonAPI/util >weather.py --clouds 100 --rain 80 --wetness 100
```
![weather_wetness](/img/posts/2020-03-03/wetness01.gif){:class="img-fluid"}

Regarding the __wind__, in previous releases the wind speed only was evident when tree leaves moved. Not it also affects the rain direction, the clouds movement and other types of vegetation. 
```sh
/carla/PythonAPI/util >weather.py --weather overcast
```
![weather_wind](/img/posts/2020-03-03/wind01.gif){:class="img-fluid"}

Other visual improvements have been made: rain particles have been changed for a more realistic effect. The sun intensity, regulated by the sun position and cloudiness, affects the intensity and color temperature of the light. Also, quite similar to this, the more cloudy the day is, the darker the sky will be. 

All of these can be perceived using a RGB camera sensor. The __dynamic_weather.py__ script in `/PythonAPI/examples` has been updated to include all of these changes in its cycles, but the CARLA team also provides with another script, 
CARLA team also provides a script, __Weather.py__ in  `/Utils/` that allows to set the weather parameters at will: 

```sh
#Set a morning scenario. 
/carla/PythonAPI/util >weather.py  --altitude 30
#Change the azimuth for an evening scenario. 
/carla/PythonAPI/util >weather.py  --altitude 30 --azimuth 220
```

![custom_weather](/img/posts/2020-03-03/custom_weather04.gif){:class="img-fluid"}

## Night mode
---

A whole new world in CARLA! The moment the sun disappears in the horizon (being so that the angle goes under 0), it is considered night time. 
When night comes, the city lights are automatically turned on. There are different types of street lights available, which correspond to the models that where previously in the different towns. 
```sh
#Go to night mode by locating the sun below the horizon. Midnight = -90
/carla/PythonAPI/util >weather.py  --altitude -90
```
![Streetlights](/img/posts/2020-03-03/Streetlights02.png){:class="img-fluid"}

__Warning:__ _Be careful when playing around in night mode, as the complex lightning may cause FPS drops. As an estimation, by the time of the release every city is able to manage a hundred vehicles with no drops under the 20FPS._ 

### Vehicle lights

Right now, only the vehicles managed by the user will be able to turn on their lights. These have been implemented for a specific set of vehicles so far: 
* __Bikes:__ all of them have a front and back position light. 
* __Motorcycles:__ Yamaha and Harley Davidson models 
* __Cars:__ Audi TT, Chevrolet, Dodge (the police car), Etron, Lincoln, Mustang, Tesla 3S, Wolkswagen T2 and the new guest coming to CARLA. 

Speaking of which... The Cybertruck is here! 

![Cybertruck](/img/posts/2020-03-03/Cybertruck02.png){:class="img-fluid"}

The lights included sum all of the common front and back lights in a car, and some special ones such as license plate, interior light or sirens. Some of them turn on automatically (brake and reverse lights), but most of them though are implemented to be accessed through the API. Each vehicle has the usual set of lights that could be found in real life. That means that cars count with the whole set, but bikes only have low front and back position lights. 

To turn vehicle lights on/off through the API, there is the helper class [carla.VehicleLightState](https://carla.readthedocs.io/en/latest/python_api/#carlavehiclelightstate) which contains the set of lights as flags. These can be enabled or disabled using binary operations. 

```py
#To turn on position lights  

current_lights = carla.VehicleLightState.NONE
current_lights |= carla.VehicleLightState.Position
vehicle.set_light_state(current_lights)
```
The __manual_control.py__ script provided in `/PythonAPI/examples` has been updated to include commands for lights. Left/Right blinkers correspond to the `Z/X` keys. High beams are turned on while pressing `Shift+L` and the rest of the lights follow a cycle with the `L` key that follows the structure: `off>position light+license plate>low beam>fog lights`.

![car_lights](/img/posts/2020-03-03/carlights.gif){:class="img-fluid"}

## Mesh distance fields
---

Thanks to the information gained with distance fields, the lightning and shadows in scenes can be dramatically improved using different features. In previous releases distance fields were disabled due to ghosting issues that now have been minimized. Some weird shadow behaviour might still happen, but the realism achieved using them is much greater than what the current issue is. Let's take a look. 

Using distance fields, the __Distance field shadows__ are enabled, creating diffuse shadow edges instead of hard ones. This work hand in hand with the previous method of Cascade shadows to get a much more desirable effect. Also, the __Distance field ambient occlusion__ along with the previous Screen space ambient occlusion help placing the objects on scene by creating shadows that take into consideration the proximity between elements. 

<iframe frameborder="0" class="juxtapose" width="100%" height="394" src="https://cdn.knightlab.com/libs/juxtapose/latest/embed/index.html?uid=e7b331a0-5ca4-11ea-b9b8-0edaf8f81e27"></iframe>

Mesh distance fields is quite a complex feature that allows for these and many other different ways to improve the realness of the simulation. To learn more about it and its possibilities take a look at [Unreal Engine's documentation](https://docs.unrealengine.com/en-US/Engine/Rendering/LightingAndShadows/DistanceFieldAmbientOcclusion/index.html). Some of these will be implemented in future releases. However, if the ghosting is still an issue, it is an option for the user to disable it at anytime. This can be done in two different ways, either using the Unreal Engine editor or through code. 

To disable mesh distance fields via code, in `DefaultEngine.ini` set to false the parameter `r.GenerateMeshDistanceFields=False`. To do it in the Unreal Engine Editor, go to __Project Settings__, look up _mesh distance fields_ and just disable these:  

![DisableMDF](/img/posts/2020-03-03/DisableMDF.png){:class="img-fluid"}

## ROS bridge
---

CARLA is moving towards a soon-to-be full integration with Autoware! And one of the biggest news is that there is a Debian package for the CARLA-ROS bridge available now!  

__[Visit the ROS bridge repository](http://dist.carla.org/carla-ros-bridge-melodic/)__  

!! Update repository

```sh
#After installing ROS Melodic and CARLA 0.9.8

#Add the repository
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 81061A1A042F527D &&
sudo add-apt-repository "deb [trusted=yes] http://dist.carla.org/carla-ros-bridge-melodic/ bionic main"

#Install the ROS bridge
sudo apt-get update &&
sudo apt-get install carla-ros-bridge

#The ROS bridge will be in the /opt/ folder

#Launch CARLA (this example runs the apt package)
cd /opt/carla/bin/ && ./CarlaUE4.sh 

#Add the source for melodic bridge
source /opt/carla-ros-bridge/melodic/setup.bash

#Launch ROS bridge launchfile to test
roslaunch carla_ros_bridge carla_ros_bridge.launch
```

The CARLA messages are part of the official ROS repositories now, and there is new documentation available regarding these, the installation of the ROS bridge and nodes and launchfiles available.  
IMU and Radar sensors have been added and improvements have been made to Lidar, Gnss and the RGB camera. Besides that, there is also the addition of some new packages that allow to execute OpenScenarios with the ScenarioRunner directly from ROS. The demo provided will load an AD agent that avoids collisions, respects traffic lights and follows a specified route. To sum up:  

* __carla_ros_scenario_runner__: executes OpenScenario routes. 
* __carla_ad_agent__: launches an autonomous vehicle. 
* __rviz_carla_plugin__: creates a visualization setting for CARLA in ROS. 
* __carla_ad_demo__: gathers all the previous launches to visualize an AD vehicle following a route. 

__Code snipets!!__  
__Visuals!!__

## Python API extension
---

CARLA provides now full support to all the OpenDRIVE geometries. The use of [RTrees](https://en.wikipedia.org/wiki/R-tree) accelerates queries (such as closest waypoint in a road) for older geometries and enables them for _B-splines_ and _spirals_.  
A new extension of the API is currently in progress to ensure more functionalities regarding the map and traffic conditions. For now, let's just mention the new [carla.Junction](https://carla.readthedocs.io/en/latest/python_api/#carlajunction) to help finding different ways in these road segments, and the possibility in [carla.Map](https://carla.readthedocs.io/en/latest/python_api/#carlamap) to obtain waypoints from a _.xodr_ definition.


## Traffic Manager
---

This CARLA module has been greatly improved for this release, especially regarding its behaviour in synchronous mode. Traffic Manager has full support now for multiclient and multiTM scenarios.  
Besides that, computational costs have been reduced and vehicles avoid joining crowded junctions by using an anticipation algorithm. Connectivity between waypoints has been also improved and some issues regarding junctions stated by OpenDRIVE have been fixed.  
__Code snipets!!__  
__Visuals!!__

## Documentation 
---

There have been great changes in the CARLA documentation. Almost everything has been revisited, from the __installation and build guides__ to the __Python API and sensor references__. Everything is now up to date with the current state of CARLA.  
There have been also remarkable changes on the structure of the documentation to ease the learning of newcomers and some advanced sections for experimented users. The __First steps__ section now acts as a step by step guide for newcomers, and the __Advanced steps__ include in-depth explanations for some specific CARLA features such as synchronous mode, time-step, recording...  
Highlight to the new documentation regarding the __[Traffic manager](!!)__ and the __[ROS bridge](!!)__.  

Check all of these changes in the [documentation](https://carla.readthedocs.io/en/latest/python_api/)!

And don't forget to mention that CARLA has a forum now! A place to gather doubts, contributions, suggestions... This will make easier to keep track of previous issues and solutions. 

<div class="build-buttons">
<p>
<a href="https://forum.carla.org/" target="_blank" class="btn btn-neutral" title="Go to the CARLA forum">
Visit the CARLA forum</a>
</p>
</div>

## Beta features
---
There are also completely new features in the CARLA ecosystem that are still in development. However, this is the best moment for those interested to test them and give some feedback to the CARLA team!

### SUMO co-simulation

CARLA is now also compatible with [SUMO](http://sumo.sourceforge.net/). The script named __NAME OF THE SCRIPT!!__ executes synchronous mode and connects or runs an instance of SUMO that works hand in hand with the CARLA server using SUMO's [microscopic simulation](https://sumo.dlr.de/docs/Theory/Traffic_Simulations.html). Vehicles spawned in CARLA will do so in SUMO and vice verse. In the same manner, vehicle movement is updated in both simulations to run in sync. Vehicle lights can also be updated in both simulations, however this is still a work in progress, as performance will be hindered by the cost of it.  
There are some helper scripts to translate CARLA blueprints to SUMO vehicle types so that the vehicles are the same in both simulators and fidelity between both simulations is ensured. If SUMO spawns a vehicle that does not exist in CARLA, this later will spawn a similar one, for example if the vehicle is a motorcycle, CARLA will spawn a random motorcycle blueprint. 

__Note:__ currently not all the CARLA towns are supported in SUMO. The list of supported ones goes as follow:  
__GIVE ME MA LIST!!__  
__Code snipets!!__  
__Visuals!!__  

### OpenDRIVE standalone mode

This new CARLA mode offers the possibility to run CARLA only using the _.xml_ definition of an OpenDRIVE file.  
In order to test this feature, the `config.py` script in `PythonAPI/util/` has a new argument, `-x` or `--xodr-path`, which is a string containing the path to the _.xml_ file. This calls a new method in [carla.Client](https://carla.readthedocs.io/en/latest/python_api/#carlaclient), `client.generate_opendrive_world()`, which blocks the simulation (as `load_world()` would do) until the new map is on the run.  
Regarding this mode there are some considerations to be taken into account:  

* OpenDRIVE maps created with RoadRunner present issues regarding tilted junctions.  
* The standalone mode uses the _.xml_ directly so any issue in it will translate to the simulation. This is an issue especially at junctions, where many lanes are mixed. 
* The map will consists of only roads and sidewalks with no walls, just void outside of them. Vehicles will fall when driving outside of these. 
* Traffic lights are not supported yet. 
* Lateral slope for roads is not supported yet.  
* The sidewalks height is currently hardcoded. This ensures collisions with them are detected even if the map definition does not include this field.  
__Code snipets!!__  
__Visuals!!__  

## Changelog
---

- __Debian repositories__ for CARLA release and ROS bridge. 
- __CARLA forum__ open to everybody. 
- __OpenDRIVE standalone mode__:  
  + New argument `--xodr-path` in `config.py` to load _.xml_ files into CARLA.
- __SUMO co-simulation__:  
  + New script `!!` to run a SUMO simulation synchronously with CARLA.  
  + Helper scripts `!!` to translate CARLA blueprints into SUMO vehicle types.  
- __New documentation__:
  + Getting started: Introduction and Quickstart. 
  + CARLA build: Linux build, Windows build, Update CARLA, F.A.Q.
  + First steps: Core concepts, 1st. World and client, 2nd. Actors and blueprints, 3rd. Maps and navigation, 4th. Sensors and data. 
  + Advanced steps: Recorder, Rendering options, Synchrony and time-step, Traffic Manager.
  + ROS bridge: ROS bridge installation, CARLA messages reference, launchfiles reference. 
  + References: Python API reference, Sensors reference. 
- __Traffic manager__:  
  + Support to multiclient and multiTM scenarios. 
  + Enhanced waypoint connectivity.  
  + Improved performance by avoiding internal lists repetitions.  
  + Traffic light groups have now customized time cycles to improve performance and avoid jams.  
  + Anticipation algorithm for vehicles near crowded junctions. 
- __Python API extensions__:  
  + New class _Junction_.  
  + Class _Waypoint_ extended. 
  + Class _Vector3D_ extended. 
  + Method _get_waypoint()_ extended for new geometries.
  + OpenDRIVE spirals and splines support.
- __ROS bridge__:  
  + Creation of a Debian package for ROS bridge installation. 
  + New sensors added: IMU and Radar. Improvements on previous sensors. 
  + New packages: carla_ad_agent, carla_ad_demo, carla_ros_scenario_runner, rviz_carla_plugin. 
- __Mesh distance fields implementation__:
  + Distance field shadows. 
  + Distance field ambient occlusion. 
- __Weather extension__: 
  + Fog feature with density and distance parameters. 
  + Wetness (percentage) feature: humidity of the road. 
  + Wind affects clouds, vegetation and rain direction. 
  + New features are accessible from the Python API. 
  + Weather script in `/Utils` eases weather control by the user. 
  + New rain particles. 
- __Night mode__: 
  + Night defined as the moment sun goes below 0 degrees (horizon). 
  + City lights automatically turn on when in night mode (listed below).  
  + Car lights have been added for a few examples (listed below).  
- __City lights available in night mode__: 
  + Highway light.
  + Multiple highway light. 
  + Simple street light.
  + Double street light. 
  + Wall street light. 
  + Tall lampost street light. 
  + Short lampost street light. 
  + Lampost wall. 
  + Railway light. 
- __Vehicle lights__: 
  + Lights are only available for user controlled cars. 
  + Lights have to be turned on by the user. Otherwise these will be off even in night mode.
  + All the lights are accessible from the API.  
  + Manual control `L` key manages lights in four states: off, position, low beam and fog lights. 
  + Manual control `shitf+L` turns on main beam lights. 
  + Manual control `Z` and `X` control blinkers. 
  + A few lights are automatic for controlled vehicle: brake... 
- __List of vehicle lights__: 
  + Indicator (front and back).
  + Position (front and back). 
  + Antifog (front and back).
  + Low beam.
  + High beam.
  + Brake. 
  + Reverse. 
  + License plate. 
  + Special. 
- __Cars with lights__: 
  + Cybertruck. 
  + Etron. 
  + Lincoln.
  + Mustang.
  + Tesla 3S.
  + Wolkswagen T2. 
  + Chevrolet. 
  + Police car (Dodge). 
  + Audi TT. 
- __Motorycles with lights__: 
  + Yamaha. 
  + Harley Davidson.
- __Bikes with lights__: 
  + All of them. 
- __New assets__:
  + New vehicle: Cybertruck. 
- __Visual quality__:
  + Sun intensity determines color temperature of the light. 
  + Sun intensity affected by sun position and cloudiness. 
  + Darkness of the clouds affected by amount of these. 
  + New sets of colors for vehicles to look more realistic. 
  + Different LODs for vehicles with no effect on lights. 
- __Fixes__:
  + Docker: binary build issue fixed. 
  + Python API documentation: index now properly ordered. 
  + Town 03: inconsistencies between OpenDRIVE and some traffic signs.
  + Traffic manager: fake lane changes (especially  present in Town03) have been fixed.
  + Traffic manager: fake junctions (present in barns and double lanes with lane departures) have been fixed.
  + Traffic manager: stuck vehicles now are deleted after 90 seconds both in asynchronous and synchronous modes (---> wait, simulated or real seconds?).  
  + Windows: make Python API fixed. 
  + ROS bridge: tf publishing in synchronous mode. 
- __Warning__:
  + Night mode with lots of actors on scene causes FPS drops that may interfere with the Traffic Manager.