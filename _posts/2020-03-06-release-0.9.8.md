---
layout: post
comments: true
title:  "CARLA 0.9.8 release"
subtitle: "CARLA and ROS Debian packages, night mode, weather extension, improvements on the traffic manager, new documentation, SUMO co-simulation and much more."
description: "CARLA and ROS Debian packages, night mode, weather extension, improvements on the traffic manager, new documentation, SUMO integration and much more."
author: "@sergi-e"
date:   2020-01-04 20:00:00 +0002
image: 'img/carla.jpg'
background: '/img/posts/2019-12-11/Bann001.jpg'
---

The CARLA team is delighted to finally announce the release of  **CARLA 0.9.8**!

This release makes for a new CARLA experience. Many different aspects have been improved, and there is one remarkable feature that should be highlighted first of them all. Debian repositories have been developed for CARLA releases and the ROS bridge, in order to make much simpler their installation in Linux systems.  

This post will dive deep into these and the rest of improvements made, but first of all here is a brief summary of what CARLA 0.9.8 brings to the table:  

* __[Debian installation for CARLA.](#carla-098-apt-installation)__ A step-by-step guide on how to use the Debian package to get the latest release.  
* __[ROS bridge.](#ros-bridge)__ Finally the integration between CARLA and ROS is ubiquitous and out-of-the-box.  
* __[Python API extension!!.](#python-api-extension)__ including all the OpenDRIVE geometries and new features for an upcoming major extension.  
* __[Traffic Manager.](#traffic-manager)__ This upgrade includes major fixes for synchronous mode and multiclient managing, and a reduction in computational costs.  
* __[SUMO integration](#sumo-co-simulation)__ _(experimental)_. CARLA now runs co-simulations with SUMO, a road traffic simulator prepared to handle large road networks.  
* __[OpenDRIVE Standalone mode](#opendrive-standalone-mode)__ _(experimental)_. This new feature allows generating road meshes in CARLA using just an OpenDRIVE file.  
* __[Documentation.](#documentation)__ Previous writing has been revisited to improve installation guides and include first steps for newcomers and in-depth explanations of advanced features.  
* __[Weather extension.](#weather-extension)__ A full configurable weather, now including fog, wetness of the road and many visual improvements.  
* __[Night mode.](#night-mode):__ Now the sun sets in CARLA and the streets and vehicles turn on their lights. A complete makeover for the simulations.  
* __[Mesh distance fields.](#mesh-distance-fields)__ Generating these meshes in Unreal Engine will greatly increase realism in CARLA simulations.  
* __[General fixes.](#changelog)__ This release includes major fixes for many features. All of these are listed in the changelog available lastly in this post.  

Let's take a look! 

{% include youtube.html id="9aFK-enG5dQ" %}

{% include release_button.html release_tag="0.9.8" %}

<br>

## Debian installation for CARLA
---

The Debian package system consists of an online repository containing a collection of files to easily distribute CARLA. This is available in Linux using tools such as the APT command and makes the installation of a CARLA release a straightforward process.  

The following commands show how to use APT to install CARLA in a Linux system. Right now the repository contains CARLA 0.9.7, but 0.9.8 will be available in a few days.  

```sh
# Install dependencies
pip install --user pygame numpy
# Add the repository
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys DB53A429E64554FC &&
sudo add-apt-repository "deb [trusted=yes] http://dist.carla.org/carla-0.9.7/ bionic main"
# Install CARLA
sudo apt-get update
sudo apt-get install carla
# CARLA is in the /opt/ folder
cd /opt/carla
# Get the resources for the simulator. 
./ImportAssets.sh
# Run the CARLA server. 
cd bin
./CarlaUE4.sh
```

## ROS bridge
---

CARLA is moving towards a soon-to-be full integration with Autoware, and in its way to do so, an out-of-the-box integration between CARLA and ROS is now granted. The creation of a Debian package for the CARLA-ROS bridge eases the installation process. Now, the ROS bridge can be installed in Linux systems using tools such as APT. Let's take a look at how: 

```sh
# After installing ROS Melodic and CARLA 0.9.8
# For ROS Kinetic, change "melodic" instances for "kinetic" and the key server to 9BE2A0CDC0161D6C

# Add the repository
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 81061A1A042F527D &&
sudo add-apt-repository "deb [trusted=yes] http://dist.carla.org/carla-ros-bridge-melodic/ bionic main"

# Install the ROS bridge
sudo apt update &&
sudo apt install carla-ros-bridge-melodic

# The ROS bridge will be in the /opt/ folder

# Launch CARLA (this example runs the apt package)
cd /opt/carla/bin/ && ./CarlaUE4.sh 

# Add the source for melodic bridge
source /opt/carla-ros-bridge/melodic/setup.bash

# Launch ROS bridge launchfile to test
roslaunch carla_ros_bridge carla_ros_bridge.launch
```

Aside from that, the CARLA messages have a specific [repository](https://github.com/carla-simulator/ros-carla-msgs) and soon will available from ROS-buildfarm. Sensors have also been upgraded, now including IMU and Radar and with some improvements to Lidar, Gnss and RGB camera. The ROS bridge includes now packages to run traffic scenarios directly from ROS. The demo provided will load an autonomous driving agent that avoids collisions, respects traffic lights and follows a specified route. To sum up:  

* __carla_ros_scenario_runner__: executes a scenario according to an OpenScenario file. 
* __carla_ad_agent__: launches an autonomous vehicle. 
* __rviz_carla_plugin__: creates a visualization setting for CARLA in ROS. The camera orientation can be changed directly from the RVIZ view and manual control can be enabled and conducted in the same window using a grid. 

The __carla_ad_demo__ meta-package is an all-in-one that brings everything together. 

```sh
roslaunch ros_ad_demo ros_ad_demo.launch
```
![ros_ad_demo](/img/posts/2020-03-03/ros_ad_demo02.gif){:class="img-fluid"}

## Python API extension
---

CARLA provides now full support to all the OpenDRIVE geometries. The use of [RTrees](https://en.wikipedia.org/wiki/R-tree) accelerates queries (such as closest waypoint in a road) for older geometries and enables them for _B-splines_ and _spirals_.  

Additionally, the functionalities of the PythonAPI now include the [carla.Junction](https://carla.readthedocs.io/en/latest/python_api/#carlajunction) class to help finding different ways in these road segments, and the possibility in [carla.Map](https://carla.readthedocs.io/en/latest/python_api/#carlamap) to obtain waypoints from a _.xodr_ definition.

## Traffic Manager
---

This CARLA module has been greatly improved for this release. Besides many bugfixing, the greatest changes are related to its behaviour in synchronous mode. Traffic Manager can now manage scenarios where multiple clients are running in sync. different Traffic Managers. Besides that, computational costs have been reduced, lane changes enabled and vehicles avoid joining crowded junctions by using an anticipation algorithm. Connectivity between waypoints has been also improved and some issues regarding junctions stated by OpenDRIVE have been fixed.  

![traffic_manager](/img/posts/2020-03-03/traffic_manager.gif){:class="img-fluid"}


## SUMO integration (experimental)
---

CARLA is now also compatible with [SUMO](http://sumo.sourceforge.net/) so that both can work together to run a synchronous co-simulation where everything happening in one of them, will correlate in the other one. Vehicle movement and spawning will be updated for both simulations. Vehicle lights and colors can also be synchronized optionally in both simulations.  

All the scripts related to this feature can be found in `Co-Simulation/Sumo`. It contains an example for __Town 01__ that runs the following command: 

```py
python3 run_synchronization.py -c examples/town01/Town01.sumocfg
```

![sumo_example](/img/posts/2020-03-03/sumo01.gif){:class="img-fluid"}

There are some helper scripts that translate CARLA blueprints to SUMO vehicle types so that the vehicles' specifications are the same in both simulators. If these are not used, CARLA will spawn a random vehicle based on the given SUMO vehicle type.  

![sumo_spawn](/img/posts/2020-03-03/sumo02.gif){:class="img-fluid"}

<div class="alert alert-warning">
  <small><i><strong>Warning!</strong> This feature has only been tested thoroughly in Town01.</i></small>
</div>

## OpenDRIVE standalone mode (experimental)
---

This new CARLA feature takes an OpenDRIVE file and creates a 3D mesh in CARLA map to run simulations with. In order to test this feature, the `config.py` script in `PythonAPI/util/` has a new argument, `-x` or `--xodr-path`, which is a string containing the path to the _.xml_ file. This calls a new method in [carla.Client](https://carla.readthedocs.io/en/latest/python_api/#carlaclient), `client.generate_opendrive_world()`, which blocks the simulation (as `load_world()` would do) until the new map is on the run.  

Regarding this mode there are some considerations to be taken into account:  

* OpenDRIVE maps created with RoadRunner present issues regarding tilted junctions.  
* The standalone mode uses the _.xml_ directly so any issue in it will translate to the simulation. This is an issue especially at junctions, where many lanes are mixed. 
* The map will consists of only roads and sidewalks with no walls, just void outside of them. Vehicles will fall when driving outside of these. 
* Traffic lights are not supported yet. 
* Walkers cannot cross pedestrian crossings yet. 
* Lateral slope for roads is not supported yet.  
* The sidewalks height is currently hardcoded. This ensures collisions with them are detected even if the map definition does not include this field.  

```sh
python3 config.py -x path/to/some/file.xodr
```

![OpenDRIVEStandalone](/img/posts/2020-03-03/opendrive_standalone.png){:class="img-fluid"}

## Documentation 
---

There have been great changes in the CARLA documentation. Almost everything has been revisited, from the __installation and build guides__ to the __Python API and sensor references__. Everything is now up to date with the current state of CARLA.  

There have been also remarkable changes on the structure of the documentation to ease the learning of newcomers and some advanced sections for experimented users. The __First steps__ section now acts as a step by step guide for newcomers, and the __Advanced steps__ include in-depth explanations for some specific CARLA features such as synchronous mode, Traffic Manager, ROS bridge and much more.  

Check all of these changes in the [CARLA documentation](https://carla.readthedocs.io/en/latest/python_api/)!

## Weather extension
---

Continuing the path started in CARLA to make weather fully configurable by the user, this upgrade includes two new weather parameters and many improvements on previous ones.
First of all, now __fog__ can be controlled in CARLA using two different variables. <u>Distance</u> sets the meters for the fog to start being applied. <u>Density</u> will state the opacity of the elements in scene depending on their distance from the point of view.  
```sh
/carla/PythonAPI/util >weather.py --clouds 100 --rain 80 --wetness 100 --puddles 60 --wind 80 --fog 50
```
![weather_fog](/img/posts/2020-03-03/fog01.gif){:class="img-fluid"}

There is also __wetness__ of the road, which applies a fader to the road to make it look wet. This new parameter works hand-in-hand with the previous precipitation deposits and improves realism on rainy environments.  

```sh
/carla/PythonAPI/util >weather.py --clouds 100 --rain 80 --wetness 100
```
![weather_wetness](/img/posts/2020-03-03/wetness01.gif){:class="img-fluid"}

The __wind__ parameter has been improved. Previously it was only evident when tree leaves moved. Now it also influences other types of vegetation, rain's direction and clouds' movement.  

```sh
/carla/PythonAPI/util >weather.py --weather overcast
```
![weather_wind](/img/posts/2020-03-03/wind01.gif){:class="img-fluid"}

As for other visual improvements made for this release, rain particles have been changed for the sake of realism, cludiness will darken the sky and the sun intensity is regulated by the sun position and cloudiness and influences the intensity and color temperature of the light in scene.  

All of these improvements can be perceived using a RGB camera sensor. The __dynamic_weather.py__ script in `/PythonAPI/examples` has been updated to include all of these changes in its cycles, and the __Weather.py__ in `/Utils/` allows to modify the weather parameters at will:  

```sh
# Set a morning scenario. 
/carla/PythonAPI/util >weather.py  --altitude 30
# Change the azimuth for an evening scenario. 
/carla/PythonAPI/util >weather.py  --altitude 30 --azimuth 220
```
![custom_weather](/img/posts/2020-03-03/custom_weather04.gif){:class="img-fluid"}

## Night mode
---

A whole new mode in CARLA! The moment the sun disappears in the horizon (being so that the altitude is under 0), it is considered night time and streets and vehicles turn their lights automatically on.  
```sh
# Go to night mode by locating the sun below the horizon. Midnight = -90
/carla/PythonAPI/util >weather.py  --altitude -90
```
![Streetlights](/img/posts/2020-03-03/Streetlights02.png){:class="img-fluid"}


<div class="alert alert-warning">
  <small><i><strong>Warning!</strong> The complex lightning in Night mode may cause FPS drops. By the time of the release every city is can manage a hundred vehicles and run at least at 20FPS.</i></small>
</div>

### Vehicle lights

For this release, only the vehicles managed by the user will be able to turn on their lights. The vehicles that support this feature so far are: 
* __Bikes:__ all of them have a front and back position light. 
* __Motorcycles:__ Yamaha and Harley Davidson models 
* __Cars:__ Audi TT, Chevrolet, Dodge (the police car), Etron, Lincoln, Mustang, Tesla 3S, Wolkswagen T2 and the new guest coming to CARLA. 

Speaking of which, CARLA is glad to announce the arrival of a new car model, __the Cybertruck!__

![Cybertruck](/img/posts/2020-03-03/Cybertruck02.png){:class="img-fluid"}

The light set for vehicles is base on real examples, including front and back beams, blinkers and some special ones such as license plate, interior light or sirens among others. Some of them turn on automatically (brake and reverse lights), but most of them are implemented to be accessible using the API. in order to do this, the [carla.VehicleLightState](https://carla.readthedocs.io/en/latest/python_api/#carlavehiclelightstate) class lists the set of lights as flags that can be enabled or disabled using binary operations. 

```py
# Turn on position lights  

current_lights = carla.VehicleLightState.NONE
current_lights |= carla.VehicleLightState.Position
vehicle.set_light_state(current_lights)
```
The __manual_control.py__ script in `/PythonAPI/examples` has been updated to include commands for lights. Left/Right blinkers correspond to the `Z/X` keys. High beams are turned on when `Shift+L` is pressed. There is also a specific cycle of vehicle lights that is enabled when `L` is pressed: `No lights --> position light + license plate --> low beam --> fog lights`.

![car_lights](/img/posts/2020-03-03/carlights.gif){:class="img-fluid"}

## Mesh distance fields
---

Unreal Engine uses mesh distance fields to represent elements and actors in scene and gain some information regarging the scene's illumination. In previous releases these features were disabled due to ghosting issues that now have been minimized.  

__Distance field shadows__ works along with the previous _Cascade shadows_ to create shadows with non-sharp edges base on light sources. __Distance field ambient occlusion__ helps placing the objects on scene by creating shadows that take into consideration the proximity between elements in scene.  

<iframe frameborder="0" class="juxtapose" width="100%" height="394" src="https://cdn.knightlab.com/libs/juxtapose/latest/embed/index.html?uid=e7b331a0-5ca4-11ea-b9b8-0edaf8f81e27"></iframe>

These are complex Unreal Engine features that allows for these and many other different ways to improve the realism of the simulation. To learn more about it and its possibilities take a look at [Unreal Engine's documentation](https://docs.unrealengine.com/en-US/Engine/Rendering/LightingAndShadows/DistanceFieldAmbientOcclusion/index.html). Some of these will be implemented in future releases.  

Mesh distance fields can be disabled via code, in `DefaultEngine.ini` set to false the parameter `r.GenerateMeshDistanceFields=False` or through the UE Editor. Go to __Project Settings__, look up _mesh distance fields_ and just disable these:  

![DisableMDF](/img/posts/2020-03-03/DisableMDF.png){:class="img-fluid"}

## Changelog
---

- __Debian repositories__ for CARLA release and ROS bridge. 
- __CARLA forum__ open to everybody. 
- __OpenDRIVE standalone mode__:  
  + New argument `--xodr-path` in `config.py` to load _.xml_ files into CARLA.
- __SUMO co-simulation__:  
  + Run a SUMO simulation synchronously with CARLA.  
  + Helper scripts to translate CARLA blueprints into SUMO vehicle types.  
- __New documentation__:
  + Getting started: Introduction and Quickstart. 
  + CARLA build: Linux build, Windows build, Update CARLA, F.A.Q.
  + First steps: Core concepts, 1st. World and client, 2nd. Actors and blueprints, 3rd. Maps and navigation, 4th. Sensors and data. 
  + Advanced steps: Recorder, Rendering options, Synchrony and time-step, Traffic Manager.
  + ROS bridge: ROS bridge installation, CARLA messages reference, launchfiles reference. 
  + References: Python API reference, Sensors reference. 
- __Traffic manager__:  
  + Support to multiclient and multiTM scenarios. 
  + Enhanced waypoint connectivity.  
  + Improved performance by avoiding internal lists repetitions.  
  + Traffic light groups have now customized time cycles to improve performance and avoid jams.  
  + Anticipation algorithm for vehicles near crowded junctions. 
- __Python API extensions__:  
  + New class _Junction_.  
  + Class _Waypoint_ extended. 
  + Class _Vector3D_ extended. 
  + Method _get_waypoint()_ extended for new geometries.
  + OpenDRIVE spirals and splines support.
- __ROS bridge__:  
  + Creation of a Debian package for ROS bridge installation. 
  + New sensors added: IMU and Radar. Improvements on previous sensors. 
  + New packages: carla_ad_agent, carla_ad_demo, carla_ros_scenario_runner, rviz_carla_plugin. 
- __Mesh distance fields implementation__:
  + Distance field shadows. 
  + Distance field ambient occlusion. 
- __Weather extension__: 
  + Fog feature with density and distance parameters. 
  + Wetness (percentage) feature: humidity of the road. 
  + Wind affects clouds, vegetation and rain direction. 
  + New features are accessible from the Python API. 
  + Weather script in `/Utils` eases weather control by the user. 
  + New rain particles. 
- __Night mode__: 
  + Night defined as the moment sun goes below 0 degrees (horizon). 
  + City lights automatically turn on when in night mode (listed below).  
  + Car lights have been added for a few examples (listed below).  
- __City lights available in night mode__: 
  + Highway light.
  + Multiple highway light. 
  + Simple street light.
  + Double street light. 
  + Wall street light. 
  + Tall lampost street light. 
  + Short lampost street light. 
  + Lampost wall. 
  + Railway light. 
- __Vehicle lights__: 
  + Lights are only available for user controlled cars. 
  + Lights have to be turned on by the user. Otherwise these will be off even in night mode.
  + All the lights are accessible from the API.  
  + Manual control `L` key manages lights in four states: off, position, low beam and fog lights. 
  + Manual control `shitf+L` turns on main beam lights. 
  + Manual control `Z` and `X` control blinkers. 
  + A few lights are automatic for controlled vehicle: brake... 
- __List of vehicle lights__: 
  + Indicator (front and back).
  + Position (front and back). 
  + Antifog (front and back).
  + Low beam.
  + High beam.
  + Brake. 
  + Reverse. 
  + License plate. 
  + Special. 
- __Cars with lights__: 
  + Cybertruck. 
  + Etron. 
  + Lincoln.
  + Mustang.
  + Tesla 3S.
  + Wolkswagen T2. 
  + Chevrolet. 
  + Police car (Dodge). 
  + Audi TT. 
- __Motorycles with lights__: 
  + Yamaha. 
  + Harley Davidson.
- __Bikes with lights__: 
  + All of them. 
- __New assets__:
  + New vehicle: Cybertruck. 
- __Visual quality__:
  + Sun intensity determines color temperature of the light. 
  + Sun intensity affected by sun position and cloudiness. 
  + Darkness of the clouds affected by amount of these. 
  + New sets of colors for vehicles to look more realistic. 
  + Different LODs for vehicles with no effect on lights. 
- __Fixes__:
  + Docker: binary build issue fixed. 
  + Python API documentation: index now properly ordered. 
  + Town 03: inconsistencies between OpenDRIVE and some traffic signs.
  + Traffic manager: fake lane changes (especially  present in Town03) have been fixed.
  + Traffic manager: fake junctions (present in barns and double lanes with lane departures) have been fixed.
  + Traffic manager: stuck vehicles now are deleted after 90 seconds both in asynchronous and synchronous modes (---> wait, simulated or real seconds?).  
  + Windows: make Python API fixed. 
  + ROS bridge: tf publishing in synchronous mode. 
- __Warning__:
  + Night mode with lots of actors on scene causes FPS drops that may interfere with the Traffic Manager.