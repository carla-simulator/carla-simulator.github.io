---
layout: post
comments: true
title:  "CARLA 0.9.13 Release"
subtitle: "User defined traffic manager paths, carla-agents Python package, user defined pedestrian animations and new vehicle behaviours"
description: "User defined traffic manager paths, carla-agents Python package, user defined pedestrian animations and new vehicle behaviours"
author: "@MattRowe18"
image: 'img/carla.jpg'
background: '/img/posts/2021-08-02/town10.png'
---

{% include youtube.html id="tWAg1fIDNCg" %}

{% include release_button.html release_tag="0.9.13" %}

The __0.9.13 release of CARLA__ is finally here, so read on to see how the new improvements will improve your workflow. 

CARLA 0.9.13 brings a host of new API features and improvements for pedestrian and vehicle behaviour and the traffic manager to better mimic real world behaviour of cars and people.

The most exciting new improvements come in the traffic manager. The traffic manager now offers __new API functionality__ to guide vehicles with a __user defined path__, defined by location waypoints or through route commands like left, right, straight, etc. __Vehicle lights__ can now be controlled by the traffic manager. 

The CARLA garage now has a __brand new vehicle__, the __Volkswagen T2 2021__. All generation 2 cars now include opening doors that can interact with the environment through collisions, especially useful for training and testing autonomous vehicles in car parks or on tight city streets. 

__Installation improvements:__ following a continued commitment to improve the useability of the CARLA simulator, the CARLA agents wheel is now __available through PyPi__ so can now be installed with pip. A new wheel for the core CARLA API library is now also available for Python version 3.9.

The user can also now define custom animations and gestures for pedestrians through the python API. 
 

- [__Traffic Manager__](#traffic-manager): New functions for user defined paths
- [__New and improved vehicles__](#new-and-improved-vehicles): A brand new vehicle and opening doors with improved braking and gear behaviour
- [__Runtime texture updating__](#runtime-texture-updates): Runtime texture updating through the CARLA Python API
- [__Python library upgrades__](#python-library-upgrades): carla-agents library now available through PyPi and new Python 3.9 wheels

## Traffic Manager

### User defined paths

The traffic manager has been extended with some great new functionality to extend user control over the behaviour of vehicles in the traffic manager. The API now exposes new traffic manager functions that can be used to guide vehicles with a user-defined custom path.

The traffic manager now exposes the `get_next_action` function to access the next action that a traffic manager guided vehicle will take and the `get_all_actions` enables the user to query all possible actions a traffic manager guided vehicle has available.

The `set_path` function allows a custom route to be defined using coordinates defined as CARLA Locations:

```py
path = [carla.Location(x=-506.696198, y=179.384308, z=0.038194),
                    carla.Location(x=-504.745972, y=232.868927, z=0.039417)]
traffic_manager.set_path(vehicle, path)
```
The `set_route` function allows a custom route to be defined using route commands:

```py
route = ["Right", "Straight", "Right", "Right", "Left", "Right"]
 traffic_manager.set_route(vehicle, route)
```

![set_route](/img/posts/2021-11-07/follow_route.gif){:class="img-fluid rounded mx-auto d-block"}

### Traffic manager controlled vehicle lights

The traffic manager now has functionality to control vehicle lights. Headlights, fog lights and indicators are controlled according to vehicle route data and weather conditions. Indicator lights will activate according to the next planned turn in the route, braking lights will activate when the vehicle brakes are applied and fog lights and main beams are activated according to the weather and light conditions. During night, the vehicle main beams are activated and in foggy conditions the rear fog lights are activated. 



## New and Improved Vehicles

### Opening Doors

All generation 2 vehicles now have articulated doors that can be opened and closed through functions in the python API. This functionality is ideal for simulating scenarios in busy city streets and car parks where doors may open unpredictably while driving past or might be blocking access to parking spaces or passageways. 

![doors](/img/posts/2021-11-07/doors.gif){:class="img-fluid rounded mx-auto d-block"}

### Improved vehicle behaviour - gears and braking

Vehicle physics has been improved with updated acceleration, braking and gear behaviours. The acceleration and braking behaviour of the vehicles has been carefully remodelled to more accurately capture the behaviour of the CARLA garage vehiclesâ€™ real world counterparts, with much care taken to reproduce published braking distance behaviour as accurately as possible. Similarly the gear change behaviour has been altered to better model real world behaviour gear changes.

![accelleration](/img/posts/2021-11-07/acceleration.gif){:class="img-fluid rounded mx-auto d-block"}

### New Volkswagen van

The CARLA garage has built an exciting new vehicle, the __Volkswagen T2 2021__. Add some charm to your city traffic with this beautifully retro styled vehicle. 

![vwvan](/img/posts/2021-11-07/vwvan.gif){:class="img-fluid rounded mx-auto d-block"}

## Python library upgrades

Continuing to improve the useability of the CARLA Python API, the CARLA agents package that allows custom control of NPC vehicles within the simulation is now distributed through PyPi. Up until now the CARLA agents package has been delivered as an egg file in the CARLA core package, requiring environment variable adjustments to function .`carla-agents` is now available as a python wheel through PyPi, allowing a convenient installation through the native python package manager PIP.

![pip_install](/img/posts/2021-11-07/pip_install_carla_agents.gif){:class="img-fluid rounded mx-auto d-block"}


New wheels are now available for Python version 3.9 for both Linux and Windows. 

## Custom pedestrian animations using the Python API

Pedestrian animations can now be customised through the Python API, allowing user-defined gestures and behaviours for pedestrian actors within the simulation. The API exposes functions to access actor's bones and define custome paths for controlling the pedestrian bodies. This allows the posibility to add gestures beyond standard walking behaviour such as waving, crouching, jumping or falling. This exciting new functionality allows the development of a range of critical scenarios for autonomous vehicles such as a traffic warden at a junction, pedestrians talking on the phone, children playing sports in the road or walking a dog. 

The following animation shows a custom animation handled by the API blending between the neutral pose and a custom walking animation handled through the API:

![pedestrian_animation](/img/posts/2021-11-07/pedestrian_animation.gif){:class="img-fluid rounded mx-auto d-block"}

The following code gets a pedestrian's bones controlling the arms and adjusts the arms' pose:

```py
# get the bones
bones = actor.get_bones()

# modify some bones
new_pose = []
for bone in bones.bone_transforms:
    if bone.name == "crl_foreArm__L":
        bone.relative.rotation.pitch -= 90
        new_pose.append((bone.name, bone.relative))
    elif bone.name == "crl_foreArm__R":
        bone.relative.rotation.pitch -= 90
        new_pose.append((bone.name, bone.relative))

# set the new pose
control = carla.WalkerBoneControlIn()
control.bone_transforms = new_pose
actor.set_bones(control)

# blend the pose
actor.blend_pose(0.5)
```

## Runtime texture updating

The API now exposes functionality to update textures during runtime to allow texture modification without relying on the UE4 editor. This can be useful for example when training neural networks to reduce the potential for overfitting, allowing more emphasis on features of road layout or buildings rather than surface textures. 

```py
texture = carla.TextureColor(width,height)
for x in range(0,len(image[0])):
    for y in range(0,len(image)):
        color = image[y][x]
        r = int(color[0])
        g = int(color[1])
        b = int(color[2])
        a = int(color[3])
        texture.set(x, height - y - 1, carla.Color(r,g,b,a))
world.apply_color_texture_to_object('SM_Cartel_Add_5', carla.MaterialParameter.Diffuse, texture, 0)
```

## Changelog 

- Added the option for users to set a path using locations to a vehicle controlled by the Traffic Manager.
- Added a RoadOption element in each SimpleWaypoint to specify which action will the vehicle perform if it follows that route.
- Added the option for users to set a route using RoadOption elements to a vehicle controlled by the Traffic Manager.
- Cache now has an extra folder with current version of CARLA (so different cache per version)
- Added new instance aware semantic segmentation sensor sensor.camera.instance_segmentation
- Added new API classes: MaterialParameter, TextureColor and TextureFloatColor to encode texture data and field (normal map, diffuse, etc)
- Added new API functions: apply_color_texture_to_object, apply_float_color_texture_to_object and apply_textures_to_object to paint objects in runtime
- Added set_percentage_random_left_lanechange and set_percentage_random_right_lanechange.
- Improved handling of collisions in Traffic Manager when driving at very high speeds.
- Added open/close doors feature for vehicles.
- Added API functions to 3D vectors: squared_length, length, make_unit_vector, dot, dot_2d, distance, distance_2d, distance_squared, distance_squared_2d, - get_vector_angle
- Added a seed for better reproducibility of pedestrians
- New API function set_pedestrians_seed
- New parameter --seedw in generate_traffic.py script
- Added API functions to 2D vectors: squared_length, length, make_unit_vector
- Added missing dependency libomp5 to Release.Dockerfile
- Added API functions to interact with pedestrian bones:
- get_bones / set_bones: to get/set the bones of a pedestrian
- blend_pose: to blend a custom pose with current animation
- show_pose / hide_pose: to show or hide the custom pose
- get_pose_from_animation: to set the custom pose with the animation current frame
- Added physical simulation to vehicle doors, capable of opening and closing
- Improved collision detection of the Python agents
- Added the new VehicleLightStage to the Traffic Manager to dynamically update the vehicle lights.
- Added two new examples to PythonAPI/util: Conversion of OpenStreetMaps to OpenDRIVE maps osm_to_xodr.py and Extraction of map spawn points extract_spawn_points.py

## Fixes

- Fixed keep_right_rule parameter
- Fixed RSSSensor: made client side calculations threaded
- Fixed the import of props without any map
- Fixed global route planner crash when being used at maps without lane markings
- Fixed bug causing the server to sigsegv when a vehicle collides an environment object in recording mode
- Cache now has an extra folder with current version of CARLA (so different cache per version)