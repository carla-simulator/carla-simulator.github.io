---
layout: post
comments: true
title:  "CARLA 0.9.11 Release"
subtitle: "Deterministic Traffic Manager and rag dolls, new and updated maps, new vehicles, beta 
integrations of CarSim and Scenic and improvements to the ROS bridge"
description: "Deterministic Traffic Manager and rag dolls, new and updated maps, new vehicles, beta 
integrations of CarSim and Scenic and improvements to the ROS bridge"
author: "@corkyw10"
date:   2020-12-01 10:00:00 +0002
image: 'img/carla.jpg'
background: '/img/posts/2019-12-11/Bann001.jpg'
---

What better way to round off the year than with the release of __CARLA 0.9.11?__ 

In this release there has been a big focus on bringing __determinism__ and thus more 
reliability to CARLA. __Traffic Manager__ can now be used in deterministic mode and __rag dolls__ are 
even deterministic by default! 

Improvements have been made to several CARLA features. The __PhysX Vehicle Manager__ has been 
enhanced to provide more realistic wheel physics and a smoother drive. We have built upon our 
__maps__ to provide the ability to toggle every environment object individually. We also have 
__new versions of all our maps__ in which users can load and unload the maps in layers. The __ROS 
bridge__ has plenty of improvements too, most notably the ability to spawn pseudo sensors, which 
allows the user much more control.

There have been several new additions to the CARLA world too. We are proud to present the 
beta integration of __CarSim__, a powerful and specialised vehicle dynamics simulator. We are 
also excited to announce the beta integration of the __Scenic__ traffic scenario specification 
language. And finally, we've added __four new vehicles__ to the blueprint library!  

Here's a rundown of the features that come with CARLA 0.9.11:

* __[Improved PhysX Vehicle Manager](#improved-physx-vehicle-manager)__ - Sweep collision 
  control improves the wheel physics of our 4 wheeled vehicles
* __[Map Sublevels](#map-sublevels)__ -  New "Otp" maps have been created that can be loaded and 
  unloaded in layers
* __[Toggle Environment Objects](#toggle-environment-objects)__ - Each environment 
  object can be enabled and disabled across all maps
* __[Deterministic Traffic Manager](#deterministic-traffic-manager)__ - Use Traffic Manager in 
  deterministic mode across the same conditions
* __[Deterministic Rag Dolls](#deterministic-rag-dolls)__ -  Rag dolls are deterministic by default
* __[New Vehicles](#new-vehicles)__ - Four new vehicles added to the blueprint library
* __[CarSim Integration (Beta)](#carsim-integration-beta)__ - Beta integration of the specialised 
  vehicle 
  dynamics simulator
* __[Scenic Integration (Beta)](#scenic-integration-beta)__ - Beta integration of the traffic 
  specific 
  programming language
* __[ROS Bridge Improvements](#ros-bridge-improvements)__ - Spawn and destroy actors via ROS 
  services, generate pseudo sensors, new passive mode and integration of DVS camera and semantic 
  LIDAR
* __[Contributors](#contributors)__ - A space to thank all the contributors to this latest 
  release of CARLA
* __[Changelog](#changelog)__ - A summary of the additions and fixes featured in this release
  
## Improved PhysX Vehicle Manager

The physics control of our four wheeled vehicles has been updated. Users will now have the option 
to turn on sweep collision control to improve wheel physics. Sweep collision control allows for 
all possible contact planes along the wheel to be considered and thus ensure a smoother drive 
over obstacles and bumps in the scenery. No more sudden jumps nor sinking into the curb!

![sweep_wheels](/img/posts/2020-12-22/wheels_smallest.gif){:class="img-fluid rounded mx-auto d-block"}

Sweep collision control is accessed via the !——- class(link)! and can be enabled easily using the 
following code:

```py
physics_control = vehicle.get_physics_control()
physics_control.use_sweep_wheel_collision = True
vehicle.apply_physics_control(physics_control)
```

You can get started straight away with the `manual_control.py`(link or where to find it) example 
script.

Read more about the PhysX implementation of sweep queries [here](https://docs.nvidia.com/gameworks/content/gameworkslibrary/physx/guide/Manual/Vehicles.html#wheel-contact-beyond-raycasts).

## Map Sublevels

New versions of all our maps have been released and boast some additional features. The new maps 
(identified with the suffix "Otp") have the same layout as previous ones but have been 
split into sublevels. This 
allows users to [load](https://carla.readthedocs.io/en/latest/python_api/#carla.World.load_map_layer) 
and [unload](https://carla.readthedocs.io/en/latest/python_api/#carla.World.load_map_layer) maps 
in layers. [Available layers](https://carla.readthedocs.io/en/latest/python_api/python_api/#carla.MapLayer) are as follows:

* __NONE__ - No layers selected.
* __Buildings__
* __Decals__
* __Foliage__
* __Ground__
* __ParkedVehicles__
* __Particles__
* __Props__
* __StreetLights__
* __Walls__
* __All__ - All layers selected. 

![sublevels](/img/posts/2020-12-22/sublevels.gif){:class="img-fluid rounded mx-auto d-block"} 

<div class="alert alert-warning">
  <small><i><strong>Warning! </strong>Sublevels are only available in "Otp" maps</i></small>
</div>

## Toggle Environment Objects

Users can now toggle individual environment objects within both old and new maps. Each [object](https://carla.readthedocs.io/en/latest/python_api/#carla.EnvironmentObject) 
in the environment has a unique ID that can be [fetched](https://carla.readthedocs.io/en/latest/python_api/#carla.World.get_environment_objects) and used to turn that object [off 
and on](https://carla.readthedocs.io/en/latest/python_api/#carla.World.enable_environment_objects). 

![toggle_objects](/img/posts/2020-12-22/objects_small.gif){:class="img-fluid rounded mx-auto d-block"} 

## Deterministic Traffic Manager

Users will now have the option to use Traffic Manager in deterministic mode. This will allow 
Traffic Manager to have the exact same output over distinct executions of a script as long as 
the same conditions are maintained. 

Deterministic mode is easily turned on by providing an arbitrary seed value to the following 
[method](https://carla.readthedocs.io/en/latest/python_api/#carla.TrafficManager.set_random_device_seed):

```
my_tm.set_random_device_seed(seed_value)
```

The most important thing to keep in mind when using deterministic mode with Traffic Manager is 
that __both the world and Traffic Manager must be in synchronous mode__ to use it. It is not 
possible to achieve determinism in asynchronous mode due to the reduced amount of control this 
mode allows the client over the simulation. Read more about synchrony in CARLA and how to activate it [for the 
world](https://carla.readthedocs.io/en/latest/adv_synchrony_timestep/#setting-synchronous-mode) 
and for [Traffic Manager](https://carla.readthedocs.io/en/latest/adv_traffic_manager/#synchronous-mode).

## Deterministic Rag Dolls

Rag dolls are now deterministic by default. This brings more reliability to the CARLA 
experience. Deterministic rag dolls can be toggled via the [`deterministic_ragdolls`]((https://carla.readthedocs.io/en/latest/python_api/#carla.WorldSettings.deterministic_ragdolls)) variable in 
class `carla.WorldSettings`. When set to true, pedestrians have less realistic death animation 
but determinism is ensured. When false, simulation and collision are more realistic but 
determinism is not ensured. 

(GIF)

## New Vehicles

CARLA's showroom now boasts 4 new vehicles! This brings the total of available vehicles in the
[blueprint library](https://carla.readthedocs.io/en/latest/bp_library#vehicle) up to 31. With these latest additions you
can now take a spin in our brand new Lincoln MKZ 2020, Mercedes-Benz Class C Coupe, Dodge 
Charger 2020 and Dodge Police Vehicle! 

![stills_cars](/img/posts/2020-12-22/stills_cars.jpg){:class="img-fluid rounded mx-auto d-block"} 

## CarSim Integration (Beta)

We are happy to announce the beta integration between CARLA and CarSim. [CarSim](https://www.carsim.com/products/carsim/index.php)
is a software tool from Mechanical Simulation that simulates the dynamic behaviour of passenger 
vehicles and light-duty trucks. Using a 3D multibody dynamics model, it reproduces the physics 
of a vehicle in response to different controls (steering, throttle, braking, gear shifting) from 
a driver and/or automation. 

This new beta integration is great news for users of both CARLA and CarSim as it paves the way for the 
most powerful features of both platforms to be combined. Multiple vehicle simulations with collision
capability on complex maps can be run in CARLA and then data can easily be analysed with CarSim's highly
specialised vehicle dynamics tools.

![carsim](/img/posts/2020-12-22/carsim.gif){:class="img-fluid rounded mx-auto d-block"}

If you are interested in learning more about CarSim before using it 
with CARLA, they have a great [2 part introduction](https://www.youtube.com/watch?v=x9EeGjy9uZc) to the tool on their YouTube channel.

<div class="alert alert-warning">
  <small><i><strong>Warning!</strong> This feature is still in experimental phase.</i></small>
</div>

## Scenic Integration (Beta)

We are also proud to announce the beta integration of the Scenic programming language. [Scenic](https://github.com/BerkeleyLearnVerify/Scenic) is a domain-specific probabilistic programming 
language specifically created to easily define traffic scenarios. Our ongoing work with Scenic 
will allow for straightforward simulation of these traffic scenarios using CARLA.     

Below, there is a snippet of [Traffic Scenario 03](https://leaderboard.carla.org/scenarios/) 
from the CARLA Challenge created with Scenic. Here we are using Scenic to create a situation 
where a pedestrian crosses the road unexpectedly and the ego vehicle is required to react safely.   

```py
# SET SCENARIO PARAMETERS AND MODEL
param map = localPath('../../../tests/formats/opendrive/maps/CARLA/Town01.xodr')
param carla_map = 'Town01'
model scenic.simulators.carla.model  # Here the definitions of all referenceables are defined (vehicle types, road library, etc)

# SCENARIO CONSTANTS
EGO_MODEL = "vehicle.lincoln.mkz2017"
EGO_SPEED = 10
SAFETY_DISTANCE = 10
BRAKE_INTENSITY = 1.0

PEDESTRIAN_MIN_SPEED = 1.0
THRESHOLD = 18

# BEHAVIORS:
behavior EgoBehavior(speed=10):
    try:
        do FollowLaneBehavior(target_speed=speed)
    interrupt when withinDistanceToObjsInLane(self, SAFETY_DISTANCE):
        take SetBrakeAction(BRAKE_INTENSITY)

behavior PedestrianBehavior(min_speed=1, threshold=10):
    do CrossingBehavior(ego, min_speed, threshold)

## DEFINING SPATIAL RELATIONS
lane = Uniform(*network.lanes)

spot = OrientedPoint on lane.centerline
vending_spot = OrientedPoint following roadDirection from spot for -3

# ACTOR CREATION
pedestrian = Pedestrian right of spot by 3,
    with heading 90 deg relative to spot.heading,
    with regionContainedIn None,  # Allow the actor to spawn outside the driving lanes
    with behavior PedestrianBehavior(PEDESTRIAN_MIN_SPEED, THRESHOLD)

vending_machine = VendingMachine right of vending_spot by 3,
    with heading -90 deg relative to vending_spot.heading,
    with regionContainedIn None  # Allow the actor to spawn outside the driving lanes

ego = Car following roadDirection from spot for Range(-30, -20),
    with blueprint EGO_MODEL,
    with behavior EgoBehavior(EGO_SPEED)

# REQUIREMENTS
require (distance to intersection) > 30
require (distance from vending_machine to intersection) > 30
require always (ego.laneSection._slowerLane is None)
require always (ego.laneSection._fasterLane is None)

# TERMINATION CONDITION
terminate when (distance to spot) > 30
```

Execution of the script is easy and you can see some command line options in the Scenic 
documentation [here](https://scenic-lang.readthedocs.io/en/latest/options.html#command-line-options).
The following is an example of how we can run the above script:  

```shell
scenic carlaChallenge3_dynamic.scenic --simulate
```


[GIF]

Watch this space for updates and improvements on our integration with Scenic and in the meantime, 
take a dive into the Scenic [syntax](https://scenic-lang.readthedocs.io/en/latest/syntax_details.html) 
and explore the possibilities!    

<div class="alert alert-warning">
  <small><i><strong>Warning!</strong> This feature is still in experimental phase.</i></small>
</div>

## ROS Bridge improvements

There's been quite a few improvements made to the ROS Bridge-CARLA experience. A new internal 
structure has been developed to ease the integration of the ROS bridge with external tools using CARLA. 

Actors can now be spawned and destroyed using ROS services, so we have added the [`SpawnObject`](https://github.com/carla-simulator/ros-carla-msgs/blob/master/srv/SpawnObject.srv) 
and [`DestroyObject`](https://githubcom/carla-simulator/ros-carla-msgs/blob/master/srv/DestroyObject.srv) 
services. Now that actors can be spawned and destroyed in this manner this means that users can 
define pseudo sensors. These are much like normal sensors but instead of existing in the CARLA 
context they are developed in the ROS Bridge. This allows the user much more control over the 
sensor data they gather as each user can define exactly what [pseudo sensors](https://github.com/carla-simulator/ros-bridge#pseudo-sensors)
they want to use.  

The pseudo sensors available are:
* `sensor.pseudo.actor_list`
* `sensor.pseudo.markers`
* `sensor.pseudo.objects`
* `sensor.pseudo.odom`
* `sensor.pseudo.opendrive_map`
* `sensor.pseudo.speedometer`
* `sensor.pseudo.tf`
* `sensor.pseudo.traffic_lights`

Here's an example of how pseudo sensors can be defined:

```
{   
    "objects": 
    [
        # Definition of global sensors (i.e., not attached to an actor).
        {
            "type": "sensor.pseudo.traffic_lights",
            "id": "traffic_lights"
        },
        {
            "type": "sensor.pseudo.opendrive_map",
            "id": "map"
        },
        # Definition of a vehicle with attached sensors.
        {
            "type": "vehicle.*",
            "id": "ego_vehicle",
            "sensors": 
            [
                {
                    "type": "sensor.camera.rgb",
                    "id": "rgb_front",
                    "spawn_point": {"x": 2.0, "y": 0.0, "z": 2.0, "roll": 0.0, "pitch": 0.0, "yaw": 0.0},
                    "image_size_x": 800,
                    "image_size_y": 600,
                    "fov": 90.0,
                    "sensor_tick": 0.05,
                    <ANY OTHER CARLA SENSOR ATTRIBUTE>
                },
                ...
             ]
         },
         ... 
```

Users of the Leaderboard will be interested to know that we have added a passive 
mode to the ROS Bridge. This mode has been introduced to ease the integration of external tools 
when having multiple CARLA clients running at the same time. When enabling this mode, the ROS 
bridge stays passive and other clients have the responsibility of ticking and configuring the world.

Finally in the ROS improvements, the DVS Camera and the Semantic LIDAR are now fully integrated in 
the ROS-Bridge.


## Contributors


This space is dedicated to all of those whose contributions were merged in any of the project's 
GitHub repositories during the development of CARLA 0.9.11. Thanks a lot for your hard work!

- [wx9698](https://github.com/wx9698)
- [francis0407](https://github.com/francis0407)
- [berndgassmann](https://github.com/berndgassmann)
- [fpasch](https://github.com/fpasch)
- [nagasanjay](https://github.com/nagasanjay)
- [zchrissirhcz](https://github.com/zchrissirhcz)
- [hellojql](https://github.com/hellojql)
- [Computer-CGuy](https://github.com/Computer-CGuy)
- [tvoelkel](https://github.com/tvoelkel)
- [Rjbeckwith55](https://github.com/Rjbeckwith55)
- [fnozarian](https://github.com/fnozarian)
- [adrianTJenkins](https://github.com/adrianTJenkins)
- [ebadi](https://github.com/ebadi)
- [hofbi](https://github.com/hellojql)
- [Roosstef](https://github.com/Roosstef)
- [vedthakur5](https://github.com/vedthakur5)
- [jbmag](https://github.com/jbmag)
- [s-hillerk](https://github.com/s-hillerk)
- [shreyadey23](https://github.com/shreyadey23)
- [MaWel8](https://github.com/MaWel8)
- [fabianoboril](https://github.com/fabianoboril)
- [kael53](https://github.com/kael53)
- [dsche](https://github.com/dsche)
- [Sumza](https://github.com/Sumza)
- [seowwj](https://github.com/seowwj)
- [amansinha](https://github.com/amansinha)

## Changelog  
---

- Improved the documentation for use with pandoc tool by converting html tags to their markdown equivalent
- Added parameter to carla settings to control culling
- Refactored FAQ section of docs to use minimal html and fix broken layout
- Added load_map_layer and unload_map_layer to control map layers on new maps that support subleveling
- Added get_environment_objectscall to get all the placed objects in the level
- Added enable_environment_objectscall to enable/disable objects of the level
- Added fully deterministic option for Traffic Manager, sorting vehicles by ID and avoiding race conditions
- Added the option to sweep the wheel shape for collision. This requires to patch the engine
- Added the possibility of changing physics substepping options from client
- Added 'noise_seed' to sensors to initialize the random generators
- API extensions:
  - Added actor.set_enable_gravity() function to enable/disable the gravity affecting the actor
- Upgraded to DirectX 12 on Windows
- Added horizontal_fov parameter to lidar sensor to allow for restriction of its field of view
- Extended the local planner with a lateral offset.

#### Art

- Added WorldSettings.deterministic_ragdolls to enable deterministic or physically based ragdolls

#### Fixes
- Fixed RSSSensor python3 build and import of open drive maps by updating to ad-rss v4.2.0 and ad-map-access v2.3.0. Python import of dependent 'ad' python modules reflects now the namespaces of the C++ interface and follow doxygen documentation 
- Fixed sensor transformations and sensor data transformations mismatch in IMU and camera-based sensors 
- Fixed random dead-lock on synchronous mode at high frame rate
- Fixed bug on Windows causing sun reflection artifacts
- Fixed bug in waypoint.get_landmarks() causing some landmarks to be missed when s = 0
- Fixed the actor.set_simulate_physics() for pedestrians and vehicles
- Fixed bug causing camera-based sensors to stop sending data
- Fixed the lack of determinism on the output of raycast sensors
- Fixed bug in the actor's id returned by the semantic lidar
- Fixed error when using --config parameter in make package
- Fixed dependency of library Xerces-c on package
- Fixed minor typo in the simulation data section of the documentation
- Fixed the config.py to read the .osm files in proper utf-8 encoding

