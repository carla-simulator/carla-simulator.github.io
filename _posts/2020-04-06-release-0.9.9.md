---
layout: post
comments: true
title:  "CARLA 0.9.9 release"
subtitle: "CARLA..."
description: "CARLA..."
author: "@sergi-e"
date:   2020-06-04 10:00:00 +0002
image: 'img/carla.jpg'
background: '/img/posts/2019-12-11/Bann001.jpg'
---

It's not been long, but the CARLA team is thrilled to release __CARLA 0.9.9__! Buckle up, because it comes ready to drift!  

The development has been brief but intense, and there are plenty of announces to make. There are some major upgrades, such as CARLA running on the lastest version of Unreal Engine, and a new method to ingest assets out-of-the-box using Docker. Previous features and modules are growing strong. SUMO co-simulation, OpenDRIVE standalone mode and Traffic Manager have been improved greatly. But there are also new integrations in CARLA, including the RSS sensor or the PTV-Vissim co-simulation. Even traffic signs and lights has been upgraded to be managed directly from OpenDRIVE. The documentation keeps up to date with all of these improvements, and features new tutorials. Last but not least, there is a new map in CARLA. __It is opening day in Town10HD!__ 

Here is a summary and link for every feature included in CARLA 0.9.9

*   __[CARLA running in UE4.24.](#ue-4.24-upgrade)__ CARLA runs now with the latest version of Unreal Engine.  
*   __[RSS sensor upgrade.](#rss-sensor-upgrade)__ The integration of the RSS library is now operative in the whole road network, including junctions.  
*   __[Hybrid physics in Traffic Manager.](#hybrid-physics-in-traffic-manager)__ The module has now a hybrid mode available to disable irrelevant physics far from an ego vehicle. Besides that, there are major architecture changes, and performance improvements.  
*   __[Automatized map ingestion.](#map-ingestion-automatization)__ A new way to ingest assets into CARLA that automatizes the process.  
*   __[Accesible OpenDRIVE landmarks.](#accessible-opendrive-landmarks)__ One of the game changers. CARLA now manages landmarks defined in the OpenDRIVE file. That allows for a wide set of signs, and automatic generation for traffic lights, stops and yields.  
*   __[New tutorials.](#new-tutorials)__ Now features new tutorials for retrieving data, and importing new assets into CARLA.  
*   __[PTV-Vissim co-simulation.](#PTV-Vissim-co-simulation)__ The CARLA ecosystem expands to integrate PTV-Vissim.  
*   __[Traffic light in SUMO co-simulation.](#traffic-lights-in-sumo-co-simulation)__ This new iteration introduces co-simulation of traffic lights, and  in Town04 and Town05. 
*   __[OpenDRIVE meshes refined.](#opendrive-meshes-refined)__ Crosswalks are now enabled for pedestrian navigation, and there are safety checks to avoid the vehicles from falling off into the abyss.  
*   __[New town in HD.](#new-town-in-hd)__ A completely new CARLA map designed to be the spearhead in CARLA's orientation towards realism.  

Let's take a look!

{% include youtube.html id="08Ea8Bm2Dow" %}

{% include release_button.html release_tag="0.9.8" %}

<br>

## CARLA running in UE4.24
---
CARLA is now working with the latest version of Unreal Engine. This is invisible for those users working with the release package, but there are some steps to follow in order to run the build. 

1. Delete the UE4.22 version of the system and download a UE4.24.x. 

2. Upgrade to clang-8 with the following commands. 

```sh
sudo apt install clang-8 lld-8
sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/lib/llvm-8/bin/clang++ 180
sudo update-alternatives --install /usr/bin/clang clang /usr/lib/llvm-8/bin/clang 180
rm -fr Build
make clean
make launch
```

## RSS sensor upgrade
---
The implementation of the RSS sensor has been extended. Now, the ability to consume the OpenDRIVE map information enables all the RSS features in CARLA, and full support of RSS anywhere in the map. This upgrade makes for to remarkable features.  

* __RSS works at junctions.__ Previously, the RSS worked based on road segments, and was limited to these. Now, the RSS sensor can take different road segments into consideration to make the calculations. That makes it possible to integrate junctions, where different road segments meet. When at a junction, a RSS vehicle will check for priority, and stop if necessary to give right of way and ensure safety. More about this can be read in the [official documentation](https://intel.github.io/ad-rss-lib/ad_rss/HLD-KeyDesignDecisionsAndAlternatives/) under *Handling of intersections*.

> Visuals !!

* __Stay on road mode is available.__ This RSS feature uses the map data to get a description of the road boundaries. At those boundaries, the RSS will place virtual objects, walls, that will prevent the vehicle from driving off the road. The RSS formulas apply to these objects as any other, and as a result, the vehicle will always maintain a minimum safe distance with them. By default, the feature is __Off__, and it can be switched using the variable for it in [RssSensor.road_boundaries_mode](https://carla.readthedocs.io/en/latest/python_api/#carla.RssSensor.road_boundaries_mode).

> Visuals!!

Everything regarding the RSS sensor is now detailed in the documentation. Take a look at the [RSS page](https://carla.readthedocs.io/en/latest/adv_rss/), the [RSS sensor reference](https://carla.readthedocs.io/en/latest/ref_sensors/#rss-sensor), and of course, the [Python API](https://carla.readthedocs.io/en/latest/python_api/#carlarsssensor) where the corresponding classes are described.  


## Hybrid physics in Traffic Manager
---
The Traffic Manager module counts now with a hybrid mode. If enabled, physics for vehicles far from the ego vehicle will be disabled. This feature saves up a lot of computational costs. Vehicle dynamics are not calculated, and vehicles move by teleportation. Vehicles farther than a certain radius from the ego vehicle, disable their physics, . The method [Actor.set_simulate_physics()](https://carla.readthedocs.io/en/latest/python_api/#carla.Actor.set_simulate_physics) allows for this. However, not all the physics are disregarded. Basic calculations for the linear acceleration are maintained, so that the position update is realistic. That grants that when a vehicle enables or disables its physics, the transition is fluid, and no weird behaviours show. The are two parameters ruling the hybrid mode. One is the radius that states the proximity area where physics are enabled. The other is the vehicle with `role_name = 'ego'`, that will act as center of this radius. These parameters have some specific considerations to take into account. 

*   The default radius is...!! and can be set... !!
*   The radius gets bigger the faster the ego vehicle moves. That will prevent non realistic behaviours closer to the ego vehicle.  
*   If no ego vehicle is present, all the vehicles will disable physics. 
*   If there is more than one ego vehicle... !!

The hybrid mode is disabled by default. There are two ways to enable it.  

*   [__TrafficManager.set_hybrid_phisics_mode(True)__](https://carla.readthedocs.io/en/latest/python_api/#carla.TrafficManager.set_hybrid_physics_mode). This method will enable the hybrid mode for the Traffic Manager object calling it.  
*   __Running `spawn_npc.py` with the flag `--hybrid`.__ The vehicles spawned will be registered to a Traffic Manager stated inside the script, and this will run with the hybrid physics on.  

> Visuals!!

Besides that, the module has been iterated to improve performance, and there is a minor modification in the [Vehicle.set_autopilot()](https://carla.readthedocs.io/en/latest/python_api/#carla.Vehicle.set_autopilot) method. This now needs for an attribute stating which Traffic Manager is the vehicle subscribed to. 

## Automatized map ingestion
---
Previously in CARLA, traffic lights, and traffic signs had to be created manually by the user after the map was imported. The user had to place them in the scene, add the bounding boxes that determine their influence, and set everything ready. These process is now automatic. When the simulator starts running, it generates traffic lights, stops, and yields using the information provided by the OpenDRIVE file.  

The rest of settings that had to be done manually are managed during the import. That includes for instance collisions enabling or generating pedestrian navigation. These two approaches combined make for a map ingestion process that barely needs user intervention. In fact, it can be summarized in three simple steps.  

*   Store the files in a proper folder structure.  
*   Create a simple `.json` file describing the files to import.  
*   Choose an import method. Via terminal for those working in a CARLA build, Docker to use the map in a CARLA package.  

More detailed information regarding how to create, and add a new map into CARLA can be found in the [documentation]() !!

<div class="alert alert-warning">
  <small><i><strong>On traffic lights state changes.</strong> As traffic lights are generated on the fly, the default time settings can't be changed. If desired, the user has to customize them when the simulation runs <a href="https://carla.readthedocs.io/en/latest/python_api/#carla.TrafficLight.set_green_time">using the API</a>.</i></small>
</div>


## Accesible OpenDRIVE landmarks
---
From now on, CARLA can read landmarks as defined in the OpenDRIVE map. Despite that only traffic lights, stops and yields are added into the simulation, all the landmarks can be queried from the API. In order to facilitate landmark manipulation, the API has been extended in many ways.  

*   __[carla.Landmark](https://carla.readthedocs.io/en/latest/python_api/#carla.Landmark)__ objects represent the landmark using the OpenDRIVE definition. The attributes and methods mostly describe the landmark, and the lanes and point where it is effective. [carla.LandmarkOrientation](https://carla.readthedocs.io/en/latest/python_api/#carla.LandmarkOrientation) states the orientation of the landmark with regards of the road's geometry definition. [carla.LandmarkType](https://carla.readthedocs.io/en/latest/python_api/#carla.LandmarkType) contains some common landmark types, to ease translation to OpenDRIVE types.  
*   A __[carla.Waypoint](https://carla.readthedocs.io/en/latest/python_api/#carla.Waypoint)__ can get landmarks ahead of it a certain distance. The type of landmark can be specified. 
*   The __[carla.Map](https://carla.readthedocs.io/en/latest/python_api/#carla.Map)__ retrieves sets of landmarks. It can return all the landmarks in the map, or those having an ID, type or group in common.  
*   The __[carla.World](https://carla.readthedocs.io/en/latest/python_api/#carla.World)__ acts as intermediary between landmarks, and a *carla.TrafficSign* or *carla.TrafficLight*. These landmarks are still present in the simulation, and the world can get the objects that embody those landmarks.  


## New tutorials
---
The documentation has been updated to meet with the upgrades mentioned in previous sections. Nonetheless, those are not the only changes made during this time.  

* There is a new tutorial regarding [__how to properly retrieve data from the simulation__](https://carla.readthedocs.io/en/latest/tuto_G_retrieve_data/). This is a holistic tutorial that comprises the whole process of retrieving data from start to finish. It starts with the simplest steps, such as customizing the simulation or spawning an ego vehicle. However, it also provides detailed descriptions for sensors, and explains how the recorder can be used to facilitate this process. The goal is to make sure that users can exploit CARLA, by retrieving as much data as desired in the simplest way.  

* __The tutorials regarding assets have been revisited.__ This new iteration is focused on making simpler for users to add their own assets, being these [props], [maps], [vehicles], and how to [create distribution packages] for them. 

> Links!!

## PTV-Vissim co-simulation
---
CARLA and PTV-Vissim can run a synchronous simulation. Vehicles spawned in one simulator will do so in the other, and traffic conditions will be updated in parallel. In order work, the system must count with [__PTV-Vissim__](https://www.ptvgroup.com/en/solutions/products/ptv-vissim/), and the __Driving simulator interface__ package.  

Everything related with the PTV-Vissim integration can be found in `Co-Simulation/PTV-Vissim`. There is a script in there to run the co-simulation, and examples for __Town01__ and __Town03__. Here is an example of how to run the co-simulation using the __Town03__ example. 
```sh
python3 run_synchronization.py -c examples/Town03/Town03.inpx
```

So far, this feature is still experimental, and there are some things to take into account.  

* Due to PTV-Vissim limitations, the amount of vehicles that will be spawned from CARLA has to be stated beforehand.  
> How to set this !!
* The synchronization of the vehicle's characteristics is close, but not perfect.  
* Traffic lights have not been implemented yet.  

> Visuals!! 


## Traffic lights in SUMO co-simulation
---
In order to ease the usage of this feature, there are two more examples for __Town-4__ and __Town05__ available in CARLA. These can be found in `Co-Simulation/Sumo/examples` and run with the previous synchronization script.  

However, the co-simulation can run with any OpenDRIVE file. Speaking of which, traffic lights are now also integrated in the co-simulation! As long as they are defined in the OpenDRIVE road map, they will feature in SUMO. The user also has the ability to choose which simulator is in charge of changing the traffic lights's state. The other will update state according to it in parallel. 

> How to choose who's in charge !!

> Visuals!!

## OpenDRIVE meshes refined
---

The mesh generation in the OpenDRIVE standalone mode has been greatly improved. The mesh generated at junctions has been polished to avoid weird behaviours. Instead of creating the whole map as a unique mesh, different fragments are created. Working smaller prevents unexpected issues, and also, by dividing the mesh, not all it has to be rendered at a time. This is a step towards a larger goal where the feature will be able to generate huge maps.  

> Visuals!!

On top of that there are two new additions to the feature. Crosswalks have been implemented to the pedestrian navigation, and some safety measures have been created to prevent vehicles from falling. The width of the lanes is incremented at junctions, and visible walls appear on the boundaries of the road. 

> Visuals!!


## New town in HD
---

__Town10HD__ is the new addition to CARLA. The whole purpose of it has been to push forward toward visual realism. In order to achieve that, meticulous care has been put into materials. There are new textures for elements such as sidewalks, roads, sand, and a water shader. 
> Visuals!!

The environment is based on an American city, designed using real references. Different parts of the map show different settings, such as a skycraper district, a promenade, or a humble and populated neighourhood. This town also counts with several new props carefully designed including vegetation, scultpures, a museum and a metro entrance among many others. 
> Visuals!! 

The improvements are especially visible for the buildings. The facades are now more detailed to be appealing. The streets are no longer plane series of buildings, but a vivid scene of elements that coming in and out. This premise goes from the very ground floors, now presenting different shapes and volumes, all the way up. Cubemaps have been placed at windows so that they provide with diverse home pictures.  

> Visuals!!

For the sake of creating these buildings, a new tool has been developed. __BP_Procedural_Buildings__ is a blueprint that is at the same time made compound from different blueprints. This tool allows to set specific dimensions for a building. It will be filled at random, using the blueprints contained as pieces. The final result is granted variety, and the meshes are efficiently instantiated to avoid performance issues.  

> Visuals!!

Last but not least, the road has been also carefully crafted. Each segment has been treated as a white canvas. The road came to life by painting weathering, tire marks, and day-to-day traits that made it look realistic. After that, decal textures and meshes were added to provide even more detail, such as oil splashes or dirt scattered around. 

> Visuals!! 


## Segment 02
---

The new deb package system consists of an online repository containing a collection of files to easily distribute CARLA. This is available in Ubuntu using  APT command. This feature makes the installation of CARLA a straightforward process.  

The following commands show how to use APT to install CARLA in a Ubuntu system. Right now the repository contains CARLA 0.9.7, but 0.9.8 will be available in a few days.  

![ros_ad_demo](/img/posts/2020-03-03/ros_ad_demo02.gif){:class="img-fluid"}

<div class="alert alert-warning">
  <small><i><strong>Warning!</strong> This feature has only been tested thoroughly in Town01.</i></small>
</div>

<iframe frameborder="0" class="juxtapose" width="100%" height="394" src="https://cdn.knightlab.com/libs/juxtapose/latest/embed/index.html?uid=e7b331a0-5ca4-11ea-b9b8-0edaf8f81e27"></iframe>


## Changelog
---

- __Upgrade to UE4.24.__  
  + Currently using UE4.24.x.  
  + Upgrade to clang-8.  

- __Docker ingestion.__  
  + New method to import assets using a UE Docker image.  

- __PTV-Vissim co-simulation.__  
  + How to.  
  + Limitations.  

- __SUMO co-simulation.__  
  + New towns. 04 and 05!!  
  + Traffic lights integrated!!  
  + spawn_npc.py script for SUMO!!  

- __OpenDRIVE standalone mode.__  
  + Added crosswalks for pedestrians.  
  + Security checks to prevent cars from falling into the abyss.  

- __RSS sensor.__  
  + Integration with the whole road network.  
  + RssCheck object conversion done in parallel using tbb.  
  + Generated Python interfaces of add:physics, ad::map and ad:rss types.  

- __Traffic manager.__  
  + Hybrid mode to run the module without physics when further than a distance from the ego vehicle.  
  + Performance improvement on collision calculations and waypoint binning.  
  + New iteration on the Traffic Manager inner architecture.  

- __Landmark management.__  
  + Automatic generation in the map of traffic lights, and stop and yield signals objects from the OpenDRIVE file.  

- __API extensions.__  
  + The method `carla.Vehicle.set_autopilot()` now has a `carla.TrafficManager` as parameter.  
  + Classes `carla.Landmark`, `carla.LandmarkType`, and `carla.LandmarkOrientation`.  
  + Added new methods to `carla.Map`: `get_all_landmarks()`, `get_all_landmarks_from_id()`, `get_all_landmarks_of_type()`, and `get_landmark_group()`.  
  + Added new methods to `carla.Waypoint`: `get_landmarks()`, and `get_landmarks_of_type()`.  
  + Added new methods to `carla.World`: `get_traffic_light()`, and `get_traffic_sign()`.  
  + RSS classes and enums. `carla.RssSensor`, `carla.RssRestrictor`, `carla.RssResponse`, `carla.RssEGoDynamycsOnRoute`, `carla.RssRoudBoundariesMode`, `carla.RssVisualizationMode`.  

- __Documentation.__  
  + Retrieve data tutorial.  
  + Map ingestion: importing assets, creating maps...
  + RSS specific page, sensor definition and API doc. 
  + RSS classes and enums.  
  + API separates Dunder methods.  
  + Methods ordered alphabetically with *getters* and *setters* at the end.  

- __Town10HD.__  
  + A new map available in CARLA, based on realism. 
  + New buildings, including a museum, parking, apartments, factory, hotel and different skyscrapers. 
  + New props such as fountains, 
  + New PBR materials for streets, roads, and assets.
  + BP_Power_poles. A blueprint to spawn power poles. 
  + BP_Lights. A blueprint for assets using lights that exposes these in the API. 
  + BP_Procedural_Buildings. A tool to create procedural buildings. 

- __Fixes.__  
  + Updated material for the glass of vehicle lights.  
  + Fixed autonomous agents' incorrect detection of red traffic lights affecting them.  
  + Improved `manual_control.py` for a more realistic throttle and brake.  
  + Dead links in the documentation. 
