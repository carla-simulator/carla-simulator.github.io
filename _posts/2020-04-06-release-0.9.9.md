---
layout: post
comments: true
title:  "CARLA 0.9.9 release"
subtitle: "CARLA..."
description: "CARLA..."
author: "@sergi-e"
date:   2020-04-04 10:00:00 +0002
image: 'img/carla.jpg'
background: '/img/posts/2019-12-11/Bann001.jpg'
---

The CARLA team is thrilled to release __CARLA 0.9.9__! Buckle up, because it comes ready to drift!  

The development has been brief but intense, and there are plenty of announces to make. In the smaller scope changes, CARLA runs now on lastest version of Unreal Engine, but there are major changes also. The map ingestion has been simplified to be almost out-of-the-box. There is no more need to add traffic lights, and traffic signs manually. CARLA now manages OpenDRIVE signals as landmark objects. Moreover, previous features and modules are growing strong. The RSS sensor, SUMO co-simulation, OpenDRIVE standalone mode, and Traffic Manager all have new features, and improved performance. There is even a new integration with PTV-Vissim. The documentation keeps up to date with all of these improvements, and features new tutorials. Last but not least, there is a new map in CARLA. __It is opening day in Town10HD!__ 

Here is a summary of every feature included in CARLA 0.9.9!

*   __[Upgrade to UE4.24.](#upgrade-to-ue4.24)__ Those working with a CARLA build have to do some updates, in order to run with the latest version of Unreal Engine.  
*   __[Automatized map ingestion.](#automatized-map-ingestion)__ The process to ingest assets, especially maps, is now simpler than ever. Prepare files to import, and forget about the rest.  
*   __[Accesible OpenDRIVE signals.](#accessible-opendrive-signals)__ One of the game changers. CARLA now manages the OpenDRIVE signals described in the `.xodr` as landmark objects. These will be accessible from the API. Additionally, the simulator will generate stop, yield, and traffic light objects automatically when running.  
*   __[RSS full-road integration.](#rss-full-road-integration)__ The integration of RSS is now operative on the whole road network, and the _stay on road_ feature guarantees that RSS vehicles will stay on the road.  
*   __[Hybrid physics in Traffic Manager.](#hybrid-physics-in-traffic-manager)__ The module has now a hybrid mode available to disable unnecessary physics far from an ego vehicle. This saves up a lot of calculations, and improves performance greatly. 
*   __[OpenDRIVE mesh generation refined.](#opendrive-mesh-generation-refined)__ Crosswalks are now enabled for pedestrian navigation, and there are safety checks to avoid the vehicles from falling off into the abyss.  
*   __[PTV-Vissim co-simulation.](#ptv-vissim-co-simulation)__ The CARLA ecosystem expands to integrate PTV-Vissim. Now, CARLA can run a synchronous simulation with PTV-Vissim in a similar way it did with SUMO. 
*   __[Traffic lights in SUMO co-simulation.](#traffic-lights-in-sumo-co-simulation)__ This new iteration introduces co-simulation of traffic lights, and  in Town04 and Town05. 
*   __[New tutorials.](#new-tutorials)__ A holistic tutorial about how to retrieve data will help users exploit CARLA at maximum, in the simplest way. Besides that, the assets tutorials have been revisited, to facilitate the usage of self-created assets. 
*   __[Town10 HD premiere.](#town10hd-premiere)__ A completely new CARLA map designed to be the spearhead in CARLA's orientation towards realism.  

Let's take a look!

{% include youtube.html id="08Ea8Bm2Dow" %}

{% include release_button.html release_tag="0.9.8" %}

<br>

## Upgrade to UE4.24
---
In order to update the CARLA build,there are some steps to be made. 

1. Delete the UE4.22 version of the system and download a UE4.24.x. 

2. Upgrade to clang-8 with the following commands. 

```sh
sudo apt install clang-8 lld-8
sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/lib/llvm-8/bin/clang++ 180
sudo update-alternatives --install /usr/bin/clang clang /usr/lib/llvm-8/bin/clang 180
rm -fr Build
make clean
make launch
```

## Automatized map ingestion
---
Previously in CARLA, traffic lights, and traffic signs had to be created manually by the user after the map was imported. The user had to place them in the scene, add the bounding boxes that determine their influence, and set everything ready. This process is now automatic. When the simulator starts running, it generates traffic lights, stops, and yields using the information provided by the OpenDRIVE file. The rest of settings that had to be done manually are managed during the import. That includes for instance collisions enabling, or generating pedestrian navigation.  

This new approach makes for a map ingestion process that barely needs user intervention. In fact, it can be summarized in three simple steps.  

*   Store the files in a proper folder structure.  
*   Create a simple `.json` describing the files to import.  
*   Choose an import method. Via terminal to import the assets in a CARLA build. Via Docker to create a standalone package for a CARLA distribution.  

More detailed information regarding how to create, and add a new map into CARLA can be found in the [documentation]() !!

## Accessible OpenDRIVE signals
---
From now on, CARLA can read signals defined in the OpenDRIVE map. All of them will be described in CARLA as landmark objects that can be queried from the API. In order to facilitate their manipulation, the API has been extended in many ways.  

*   __[carla.Landmark](https://carla.readthedocs.io/en/latest/python_api/#carla.Landmark)__ objects represent the OpenDRIVE signals. The attributes and methods describe the landmark, and the lanes and point where it is effective. [carla.LandmarkOrientation](https://carla.readthedocs.io/en/latest/python_api/#carla.LandmarkOrientation) states the orientation of the landmark with regards of the road's geometry definition. [carla.LandmarkType](https://carla.readthedocs.io/en/latest/python_api/#carla.LandmarkType) contains some common landmark types, to ease translation to OpenDRIVE types.  
*   A __[carla.Waypoint](https://carla.readthedocs.io/en/latest/python_api/#carla.Waypoint)__ can get landmarks ahead of it a certain distance. The type of landmark can be specified. 
*   The __[carla.Map](https://carla.readthedocs.io/en/latest/python_api/#carla.Map)__ retrieves sets of landmarks. It can return all the landmarks in the map, or those having an ID, type or group in common.  
*   The __[carla.World](https://carla.readthedocs.io/en/latest/python_api/#carla.World)__ acts as intermediary between landmarks, and the *carla.TrafficSign* and *carla.TrafficLight* that embody them in the simulation.  

Even if the the simulator generates stop, yields and traffic lights in the simulation, the way these objects are managed has not changed for the user. For instance, it is still possible to customize the traffic lights timing directly from the API. 


## RSS full-road integration
---
The implementation of the RSS sensor has been extended. Now, the ability to consume the OpenDRIVE map information enables all the RSS features in CARLA, and full support of RSS anywhere in the map. This upgrade makes for two remarkable features.  

__RSS checks priority and safety at junctions.__ Previously, the RSS worked based on road segments, and was limited to these. Now, the RSS sensor can take different road segments into consideration to make the calculations. That makes it possible to integrate junctions, where different road segments meet. When at a junction, a RSS vehicle will check for priority. If necessary, it will brake when coming closer, or even stop to give right of way, and ensure safety. More about this can be read in the [__official documentation__](https://intel.github.io/ad-rss-lib/ad_rss/HLD-KeyDesignDecisionsAndAlternatives/) under *Handling of intersections*.

![rss_junctions](/img/posts/2020-04-06/rss_junctions.gif){:class="img-fluid"}

__Stay on road mode is available.__ This RSS feature uses the map data to get a description of the road boundaries. At those boundaries, the RSS will place virtual objects, walls, that will prevent the vehicle from driving off the road. The RSS formulas apply to these objects as any other. As a result, the vehicle will always maintain a minimum safe distance with them. By default, the feature is __Off__, and it can be switched using the variable for it in __[RssSensor.road_boundaries_mode](https://carla.readthedocs.io/en/latest/python_api/#carla.RssSensor.road_boundaries_mode)__.

![rss_stay](/img/posts/2020-04-06/rss_stay.gif){:class="img-fluid"}

Everything regarding the RSS sensor is now detailed in the documentation. Take a look at the [RSS page](https://carla.readthedocs.io/en/latest/adv_rss/), the [RSS sensor reference](https://carla.readthedocs.io/en/latest/ref_sensors/#rss-sensor), and of course, the [Python API](https://carla.readthedocs.io/en/latest/python_api/#carlarsssensor) where the corresponding classes are described.  


## Hybrid physics in Traffic Manager
---
The Traffic Manager module now includes a hybrid mode. If enabled, all vehicle physics will be disabled, but can then be enabled around a certain radius once an ego vehicle (with the tag 'hero') is spawned. This feature was developed to remove the vehicle physics bottleneck from the simulator, especially for cars far away from our ego vehicle. Since vehicle physics are not active, all cars move by teleportation while following their path. This feature relies on the method [Actor.set_simulate_physics()](https://carla.readthedocs.io/en/latest/python_api/#carla.Actor.set_simulate_physics). However, not all the physics are disregarded. Basic calculations for a linear acceleration are maintained, so that the position update and vehicle speed still look realistic. Also, that guarantees that when a vehicle enables or disables its physics, the transition is fluid.  

The are two parameters ruling the hybrid mode. One is the radius that states the proximity area around any ego vehicle where physics are enabled. The other is the vehicle with `role_name='ego'`, that will act as center of this radius. These parameters have some specific considerations to take into account. 

*   The default radius is 70 meters, but can be changed by using traffic_manager.set_hybrid_mode_radius(r).  
*   If no ego vehicle is present, all the vehicles will keep physics off.  
*   If there are many ego vehicles, the radius will be considered for all of them. That will create different areas of influence with physics enabled.  

The hybrid mode is disabled by default. There are two ways to enable it.  

*   [__TrafficManager.set_hybrid_phisics_mode(True)__](https://carla.readthedocs.io/en/latest/python_api/#carla.TrafficManager.set_hybrid_physics_mode). This method will enable the hybrid mode for the Traffic Manager object calling it.  
*   __Running `spawn_npc.py` with the flag `--hybrid`.__ The vehicles spawned will be registered to a Traffic Manager stated inside the script, and this will run with the hybrid physics on.  

> Visuals!!

Besides that, the module has been iterated to improve performance, and there is a minor modification in the [Vehicle.set_autopilot()](https://carla.readthedocs.io/en/latest/python_api/#carla.Vehicle.set_autopilot) method. This now needs for an attribute stating which Traffic Manager is the vehicle subscribed to.  

## OpenDRIVE mesh generation refined
---

The mesh generation in the OpenDRIVE standalone mode has been greatly improved. Junctions have been polished to avoid inaccuracies, especially where uneven lanes joined. Instead of creating the whole map as a unique mesh, different fragments are created. Working smaller prevents unexpected issues. Also, by dividing the mesh, not all of it has to be rendered at a time. This is a step towards a larger goal, where the feature will be able to generate huge maps. 

> Visuals!!

On top of that there are two new additions. Crosswalks have been implemented to the pedestrian navigation, and some safety measures have been created to prevent vehicles from falling. The width of the lanes is incremented at junctions, and visible walls appear on the boundaries of the road. 

> Visuals!!

## PTV-Vissim co-simulation
---
This new mode allows CARLA and PTV-Vissim to run a synchronous simulation. Vehicles spawned in one simulator will do so in the other, and traffic conditions will be updated in parallel. In order work, the system must count with [__PTV-Vissim__](https://www.ptvgroup.com/en/solutions/products/ptv-vissim/), and the __Driving simulator interface__ package.  

Everything related with the PTV-Vissim integration can be found in `Co-Simulation/PTV-Vissim`. There is a script in there to run the co-simulation, and examples for __Town01__ and __Town03__. Here is an example of how to run the co-simulation using the __Town03__ example. 
```sh
python3 run_synchronization.py -c examples/Town03/Town03.inpx
```

So far, this feature is still experimental, and there are some things to take into account.  

* Due to PTV-Vissim limitations, the amount of vehicles that will be spawned from CARLA has to be stated beforehand.  
> How to set this !!
* The synchronization of the vehicle's characteristics is close, but not perfect.  
* Traffic lights have not been implemented yet.  

> Visuals!! 


## Traffic lights in SUMO co-simulation
---
In order to ease the usage of this feature, there are two more examples for __Town04__ and __Town05__ available in CARLA. These can be found in `Co-Simulation/Sumo/examples`.  

Furthermore, traffic lights are now also integrated in the co-simulation! As long as they are defined in the OpenDRIVE road map, they will feature in SUMO. The user can choose which simulator will change the state of the traffic lights. The other will update the states accordingly. 

> How to choose who's in charge !!

> Visuals!!

## New tutorials
---
The documentation has been updated to meet with the upgrades mentioned in previous sections. Nonetheless, there are some remarkable new entries.  

There is a new tutorial regarding [__how to properly retrieve data from the simulation__](https://carla.readthedocs.io/en/latest/tuto_G_retrieve_data/). This is a holistic tutorial that comprises the whole process of retrieving data from start to finish. It starts with the simplest steps, such as customizing the simulation or spawning an ego vehicle. However, it also provides detailed descriptions for sensors, and explains how the recorder can be used to facilitate this process. The goal is to make sure that users can exploit CARLA, by retrieving as much data as desired in the simplest way.  

__The tutorials regarding assets have been revisited.__ This new iteration is focused on making simpler for users to add their own assets, being these [props], [maps], [vehicles], and how to [create standalone packages] for them. 

> Links!!

## Town10HD premiere
---

__Town10HD__ is the new addition to CARLA. The whole mindset during its development was to push forward towards visual realism. In order to achieve that, meticulous care has been put into materials.  

The environment is based on an American city, designed using real references. Different parts of the map show different settings, such as a skycraper district, a promenade, or a humble and populated neighbourhood. This town also counts with several new props carefully designed including vegetation, scultpures, a museum and a metro entrance among many others.  

![town10_street](/img/posts/2020-04-06/town10_street.png){:class="img-fluid"}

Improvements are especially visible on buildings. The facades are now more detailed to be appealing. The streets are no longer plane series of buildings, but a vivid scene of elements coming in and out. This is noticeable from the very ground floors, all the way up. Cubemaps have been placed at windows so that they provide with diverse home pictures.  

![town10_facades](/img/posts/2020-04-06/town10_facades.png){:class="img-fluid"}

For the sake of creating these buildings, a new tool has been developed. __BP_Procedural_Buildings__ is a blueprint that is at the same time compound from different blueprints. All of the meshes are efficiently instantiated to avoid performance issues. By using the tool, the dimensions of the building are stated, and then filled in at random. The blueprints are used as if they were pieces to fit the mold. The final result is a varied and realistic building.  

![town10_hotel](/img/posts/2020-04-06/town10_hotel.gif){:class="img-fluid"}

Last but not least, the road has been also carefully crafted. Each segment has been treated as a white canvas. The road came to life by painting weathering, tire marks, and day-to-day traits that made it look realistic. After that, decal textures and meshes were added to provide even more detail, such as oil splashes or dirt scattered around. 

![town10_road](/img/posts/2020-04-06/town10_road.png){:class="img-fluid"}

## Changelog
---

- __Upgrade to UE4.24.__  
  + Download UE4.24.x.  
  + Upgrade to clang-8.  

- __Automatized map ingestion.__  
  + Automatic generation of traffic lights, stop and yield signals by the simulator.  
  + New Docker image to export standalone packages of assets.  

- __PTV-Vissim co-simulation.__  
  + Synchronous vehicle update between CARLA and PTV-Vissim.  
  + Vehicle spawning co-simulated.  

- __SUMO co-simulation.__  
  + New examples for Town04 and Town05.
  + Traffic lights integration.
  + spawn_npc.py script for SUMO!!  

- __OpenDRIVE standalone mode.__  
  + Added crosswalks for pedestrians.  
  + Improved mesh generation by creating it in separated in fragments. 
  + Automatic mesh smooth 
  + Security checks to prevent cars from falling into the abyss.  

- __RSS sensor.__  
  + Integration for the whole road network.  
  + Integration of intersection RSS checks.  
  + Support for stay on road feature. 
  + Classes `carla.RssSensor`, `carla.RssResponse`, `carla.RssRestrictor`, `carla.RssVisualizationMode`, `carla.RssRoadBoundariesMode` and `carla.RssEgoDynamicsOnRoute`.  

- __Traffic manager.__  
  + Hybrid mode to disable physics for vehicle farther than a distance from the ego vehicle.  
  + `carla.Vehicle.set_autopilot()` and `command.SetAutopilot()` now has a `carla.TrafficManager` as parameter.  
  + Added new methods to `carla.TrafficManager`: `set_hybrid_physics_mode()` and `set_hybrid_radius()`.  
  + Performance improvement on collision calculations and waypoint binning.  

- __Accessible OpenDRIVE signals.__  
  + Classes `carla.Landmark`, `carla.LandmarkType`, and `carla.LandmarkOrientation`.  
  + Added new methods to `carla.Map`: `get_all_landmarks()`, `get_all_landmarks_from_id()`, `get_all_landmarks_of_type()`, and `get_landmark_group()`.  
  + Added new methods to `carla.Waypoint`: `get_landmarks()`, and `get_landmarks_of_type()`.  
  + Added new methods to `carla.World`: `get_traffic_light()`, and `get_traffic_sign()`.  
  + RSS classes and enums. `carla.RssSensor`, `carla.RssRestrictor`, `carla.RssResponse`, `carla.RssEGoDynamycsOnRoute`, `carla.RssRoudBoundariesMode`, `carla.RssVisualizationMode`.  

- __Documentation.__  
  + New tutorial to retrieve data from the simulation.  
  + Assets tutorials revisited: Add vehicles, maps and props. 
  + RSS sensor page and update to sensors reference 
  + Python API updated with landmarks, Traffic Manager and RSS additions.  
  + Python API lists Dunder methods separatedly.  
  + Methods ordered alphabetically with *getters* and *setters* at the end.  

- __Town10HD.__  
  + New map developed and available.  
  + New props and buildings.
  + New PBR materials and textures for streets, roads, and assets.  
  + BP_Power_poles. A blueprint to spawn power poles.  
  + BP_Lights. A blueprint for assets using lights that exposes these in the API.  
  + BP_Procedural_Buildings. A tool to create procedural buildings.  

- __Fixes.__  
  + Updated material for the glass of vehicle lights.  
  + Fixed autonomous agents' incorrect detection of red traffic lights affecting them.  
  + Improved `manual_control.py` for a more realistic throttle and brake.  
  + Dead links in the documentation. 
